<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - WebControl Studio</title>
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/ui-kit.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/img/webcontrol-logo.png?v=3">
    <link rel="icon" type="image/svg+xml" href="/static/img/webcontrol-logo.svg?v=3">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v=3">
    <link rel="shortcut icon" href="/static/favicon.ico?v=3">
    <link rel="apple-touch-icon" href="/static/img/webcontrol-logo.png?v=3">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/static/js/main.js"></script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      .site-description {
        max-width: 420px;
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mosaic-description {
        display: -webkit-box;
        line-clamp: 3;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .site-logo {
        height: 3rem;
        width: 3rem;
      }

      .site-logo img {
        height: 100%;
        width: 100%;
        object-fit: cover;
      }

      .social-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        background-color: #f3f4f6;
        color: #374151;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .social-chip:hover {
        background-color: #e5e7eb;
      }

      .view-toggle button {
        transition: all 0.2s ease;
      }

      .mosaic-card {
        box-shadow: 0 1px 2px rgb(15 23 42 / 0.05);
      }

      #usersManagementView {
        --um-surface: rgba(255, 255, 255, 0.92);
      }

      #usersManagementView [data-hover-lift] {
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      #usersManagementView [data-hover-lift]:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 60px -30px rgba(15, 23, 42, 0.45);
      }

      #usersManagementView .wc-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
      }

      #usersManagementView .wc-toolbar__filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      #usersManagementView .wc-filter-chip {
        border-radius: 9999px;
        padding: 0.35rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.6);
        color: rgba(71, 85, 105, 0.95);
        transition: all 0.2s ease;
      }

      #usersManagementView .wc-filter-chip:hover,
      #usersManagementView .wc-filter-chip.active {
        border-color: rgba(59, 130, 246, 0.45);
        color: #1d4ed8;
        background: rgba(59, 130, 246, 0.12);
        box-shadow: 0 15px 40px -25px rgba(37, 99, 235, 0.7);
      }

      #usersManagementView .table-action {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: white;
        color: #0f172a;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      #usersManagementView .table-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 35px -25px rgba(15, 23, 42, 0.6);
        color: #2563eb;
      }

      #usersManagementView .table-action--danger:hover {
        color: #dc2626;
      }

      #usersManagementView .drawer-backdrop {
        backdrop-filter: blur(6px);
      }

      #usersManagementView .modal-panel {
        animation: usersModuleEnter 0.3s ease-out;
        box-shadow: 0 45px 80px -40px rgba(15, 23, 42, 0.45);
        max-height: calc(100vh - 3rem);
        width: min(100%, 680px);
        display: flex;
        flex-direction: column;
        background: var(--um-surface);
      }

      #usersManagementView .metric-value {
        transition: transform 0.35s ease;
      }

      #usersManagementView .metric-bump {
        animation: umMetricPulse 0.45s ease;
      }

      @keyframes umMetricPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      #usersManagementView .wc-chip--muted {
        background: rgba(148, 163, 184, 0.12);
        color: rgba(71, 85, 105, 0.9);
      }

      #usersManagementView .wc-chip--danger {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
      }

      #usersManagementView .wc-chip--warning {
        background: rgba(251, 191, 36, 0.15);
        color: #b45309;
      }

      #usersManagementView .wc-chip--success {
        background: rgba(16, 185, 129, 0.15);
        color: #047857;
      }

      #usersManagementView .wc-page-heading {
        position: relative;
        overflow: hidden;
        border-radius: 36px;
        padding: 2.75rem;
        background: radial-gradient(
            circle at 15% 20%,
            rgba(59, 130, 246, 0.35),
            transparent 55%
          ),
          linear-gradient(135deg, #0f172a, #1e1b4b);
        box-shadow: 0 40px 120px -45px rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      #usersManagementView .wc-page-heading::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 80% 20%,
          rgba(14, 165, 233, 0.4),
          transparent 45%
        );
        mix-blend-mode: screen;
        pointer-events: none;
      }

      #usersManagementView .wc-page-heading > * {
        position: relative;
        z-index: 1;
      }

      #usersManagementView .wc-page-heading__eyebrow {
        color: rgba(241, 245, 249, 0.85);
        letter-spacing: 0.35em;
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 600;
      }

      #usersManagementView .wc-page-heading__title {
        color: #f8fafc;
        font-size: 2.5rem;
        font-weight: 700;
      }

      #usersManagementView .wc-page-heading__subtitle {
        color: rgba(226, 232, 240, 0.92);
        max-width: 640px;
      }

      #usersManagementView .wc-page-heading__actions {
        margin-top: 1.35rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
      }

      @keyframes usersModuleEnter {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-50"
    data-initial-view="{{ initial_view or 'dashboard' }}"
  >
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 fixed z-30 w-full">
      <div class="px-3 py-3 lg:px-5 lg:pl-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center justify-start">
            <button
              id="toggleSidebarMobile"
              aria-expanded="true"
              aria-controls="sidebar"
              class="lg:hidden mr-2 text-gray-600 hover:text-gray-900 cursor-pointer p-2 hover:bg-gray-100 focus:bg-gray-100 focus:ring-2 focus:ring-gray-100 rounded"
            >
              <svg
                class="w-6 h-6"
                fill="currentColor"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </button>
            <a
              href="/dashboard"
              class="text-xl font-bold flex items-center lg:ml-2.5"
            >
              <img src="/static/img/webcontrol-logo.png" alt="WebControl Logo" class="w-8 h-8 rounded-lg mr-2 object-cover" onerror="this.onerror=null;this.src='/static/img/webcontrol-logo.svg';">
              <span class="self-center whitespace-nowrap"
                >WebControl Studio</span
              >
            </a>
          </div>
          <div class="flex items-center">
            <button
              id="userMenuButton"
              type="button"
              class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300"
            >
              <span class="sr-only">Abrir menú de usuario</span>
              <div
                id="userAvatar"
                class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center overflow-hidden border border-white/40"
              >
                <img
                  id="userAvatarImage"
                  alt="Avatar del usuario"
                  class="hidden w-full h-full object-cover"
                />
                <span id="userAvatarInitials" class="text-sm font-semibold"
                  >WC</span
                >
              </div>
            </button>
            <div
              id="userMenu"
              class="hidden z-50 my-4 text-base list-none bg-white rounded divide-y divide-gray-100 shadow absolute right-0 top-12"
            >
              <div class="py-3 px-4">
                <span class="block text-sm text-gray-900" id="userName"
                  >Admin</span
                >
                <span
                  class="block text-sm font-medium text-gray-500 truncate"
                  id="userEmail"
                  >admin@webcontrol.com</span
                >
              </div>
              <ul class="py-1">
                <li>
                  <a
                    href="#"
                    onclick="logout()"
                    class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100"
                    >Cerrar sesión</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="fixed hidden z-20 h-full top-0 left-0 pt-16 lg:flex flex-shrink-0 flex-col w-64 transition-width duration-75"
      aria-label="Sidebar"
    >
      <div
        class="relative flex-1 flex flex-col min-h-0 border-r border-gray-200 bg-white pt-0"
      >
        <div class="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
          <div class="flex-1 px-3 bg-white divide-y space-y-1">
            <ul class="space-y-2 pb-2">
              <li>
                <a
                  href="/dashboard"
                  data-inline-module="dashboard"
                  data-nav-route="dashboard"
                  class="text-base text-gray-900 font-normal rounded-lg flex items-center p-2 bg-gray-100 group"
                >
                  <i
                    class="fas fa-th-large w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                  ></i>
                  <span class="ml-3">Dashboard</span>
                </a>
              </li>
              <li data-owner-hidden>
                <a
                  href="/create-site"
                  class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 flex items-center p-2 group"
                >
                  <i
                    class="fas fa-plus-circle w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                  ></i>
                  <span class="ml-3">Crear Sitio</span>
                </a>
              </li>
              <li data-owner-hidden>
                <a
                  href="/models"
                  class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 flex items-center p-2 group"
                >
                  <i
                    class="fas fa-layer-group w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                  ></i>
                  <span class="ml-3">Modelos</span>
                </a>
              </li>
              <li data-superadmin-only class="hidden">
                <a
                  href="/users-management"
                  data-inline-module="users"
                  data-nav-route="users"
                  class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 flex items-center p-2 group"
                >
                  <i
                    class="fas fa-users-gear w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                  ></i>
                  <span class="ml-3">Gestión de Usuarios</span>
                </a>
              </li>
            </ul>
            <div class="space-y-2 pt-2" data-owner-hidden>
              <a
                href="https://github.com/AnSan29/webControl"
                target="_blank"
                class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 group transition duration-75 flex items-center p-2"
              >
                <i
                  class="fab fa-github w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                ></i>
                <span class="ml-3">GitHub</span>
              </a>
              <a
                href="#"
                class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 group transition duration-75 flex items-center p-2"
              >
                <i
                  class="fas fa-book w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                ></i>
                <span class="ml-3">Documentación</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <div
      class="bg-gray-900 opacity-50 hidden fixed inset-0 z-10"
      id="sidebarBackdrop"
    ></div>

    <div class="flex overflow-hidden bg-white pt-16">
      <div
        id="main-content"
        class="h-full w-full bg-gray-50 relative overflow-y-auto lg:ml-64"
      >
        <main>
          <div id="dashboardView" class="pt-6 px-4 space-y-6">
            <div>
              <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
              <p class="mt-2 text-sm text-gray-600">
                Gestiona todos tus sitios y plantillas desde un solo lugar.
              </p>
            </div>

            <div
              data-owner-only
              class="hidden bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white rounded-2xl p-5 shadow-lg flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between"
            >
              <div>
                <p class="text-xs uppercase tracking-widest text-white/80">
                  Modo owner activo
                </p>
                <h2 class="text-xl font-semibold">
                  Solo puedes administrar tu sitio asignado
                </h2>
                <p class="text-sm text-white/80 mt-1">
                  Solicita apoyo de un superadmin si necesitas crear nuevos
                  sitios u otorgar accesos adicionales.
                </p>
              </div>
              <div class="flex flex-col gap-2 w-full lg:w-auto">
                <span id="ownerSiteSummary" class="text-sm text-white/90"
                  >Sin sitio asignado todavía.</span
                >
                <a
                  id="ownerSiteShortcut"
                  href="#"
                  class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition font-semibold text-sm gap-2 pointer-events-none opacity-60"
                >
                  <i class="fas fa-pen-to-square"></i>
                  Ir al editor asignado
                </a>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div
                class="bg-white rounded-lg shadow p-6 border border-gray-200 fade-in"
              >
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div
                      class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center"
                    >
                      <i class="fas fa-globe text-blue-600 text-xl"></i>
                    </div>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">
                      Total Sitios
                    </p>
                    <p class="text-2xl font-bold text-gray-900" id="totalSites">
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="bg-white rounded-lg shadow p-6 border border-gray-200 fade-in"
                style="animation-delay: 0.1s"
              >
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div
                      class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center"
                    >
                      <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Publicados</p>
                    <p
                      class="text-2xl font-bold text-gray-900"
                      id="publishedSites"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="bg-white rounded-lg shadow p-6 border border-gray-200 fade-in"
                style="animation-delay: 0.2s"
              >
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div
                      class="w-12 h-12 rounded-lg bg-yellow-100 flex items-center justify-center"
                    >
                      <i class="fas fa-pencil-alt text-yellow-600 text-xl"></i>
                    </div>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">En Borrador</p>
                    <p class="text-2xl font-bold text-gray-900" id="draftSites">
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="bg-white rounded-lg shadow p-6 border border-gray-200 fade-in"
                style="animation-delay: 0.3s"
              >
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div
                      class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center"
                    >
                      <i class="fas fa-eye text-purple-600 text-xl"></i>
                    </div>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">
                      Visitas Totales
                    </p>
                    <p class="text-2xl font-bold text-gray-900" id="totalViews">
                      0
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
              <a
                data-owner-hidden
                href="/create-site"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <i class="fas fa-plus mr-2"></i>
                Crear Nuevo Sitio
              </a>
              <button
                onclick="refreshDashboard()"
                class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <i class="fas fa-sync-alt mr-2"></i>
                Actualizar
              </button>
            </div>

            <section
              class="bg-white rounded-lg shadow p-4 lg:p-5 space-y-4"
              aria-label="Filtros y vistas"
            >
              <div class="flex flex-col xl:flex-row gap-4">
                <div class="relative flex-1">
                  <span
                    class="absolute inset-y-0 left-3 flex items-center text-gray-400"
                  >
                    <i class="fas fa-search"></i>
                  </span>
                  <input
                    id="searchInput"
                    type="text"
                    placeholder="Buscar por nombre, modelo o dominio"
                    class="w-full pl-10 pr-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                  />
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                  <select
                    id="modelFilter"
                    class="min-w-[180px] border border-gray-200 rounded-lg px-3 py-2 bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="all">Todos los modelos</option>
                    <option value="artesanias">Artesanías</option>
                    <option value="cocina">Cocina</option>
                    <option value="belleza">Belleza</option>
                    <option value="adecuaciones">Adecuaciones</option>
                    <option value="chivos">Ganadería</option>
                  </select>
                  <button
                    id="exportCsvBtn"
                    type="button"
                    class="inline-flex items-center justify-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50"
                  >
                    <i class="fas fa-file-export mr-2"></i>
                    Exportar CSV
                  </button>
                </div>
              </div>
              <div
                class="flex flex-col sm:flex-row items-center justify-between gap-3 border-t border-gray-100 pt-4"
              >
                <p class="text-sm text-gray-500">
                  Elige cómo explorar tus sitios.
                </p>
                <div
                  class="view-toggle inline-flex rounded-lg border border-gray-200 bg-gray-50 p-1"
                  role="group"
                >
                  <button
                    type="button"
                    data-view-toggle="list"
                    class="px-4 py-2 rounded-md bg-gray-900 text-white text-sm font-medium flex items-center gap-2"
                  >
                    <i class="fas fa-list"></i>
                    Lista
                  </button>
                  <button
                    type="button"
                    data-view-toggle="grid"
                    class="px-4 py-2 rounded-md bg-white text-gray-600 text-sm font-medium flex items-center gap-2"
                  >
                    <i class="fas fa-grip"></i>
                    Mosaico
                  </button>
                </div>
              </div>
            </section>

            <section
              id="sitesCard"
              class="bg-white rounded-lg shadow overflow-hidden"
            >
              <div id="listView">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Mis Sitios Web
                  </h2>
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Sitio
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Modelo
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Estado
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Visitas
                        </th>
                        <th
                          class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                        >
                          Acciones
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="sitesTableBody"
                      class="bg-white divide-y divide-gray-200"
                    >
                      <!-- Contenido generado dinámicamente -->
                    </tbody>
                  </table>
                </div>
              </div>
              <div id="gridView" class="hidden border-t border-gray-200">
                <div
                  class="px-6 py-4 border-b border-gray-200 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between"
                >
                  <h2 class="text-xl font-semibold text-gray-900">
                    Vista en Mosaico
                  </h2>
                  <p class="text-sm text-gray-500">
                    Mini cards con vista previa, redes sociales y accesos
                    rápidos.
                  </p>
                </div>
                <div class="p-6">
                  <div
                    id="mosaicGrid"
                    class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"
                  >
                    <!-- Contenido generado dinámicamente -->
                  </div>
                </div>
              </div>
            </section>

            <div
              id="emptyState"
              class="hidden bg-white rounded-lg shadow p-12 text-center"
            >
              <div
                class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center"
              >
                <i class="fas fa-globe text-gray-400 text-4xl"></i>
              </div>
              <h3 class="text-xl font-medium text-gray-900 mb-2">
                No tienes sitios web aún
              </h3>
              <p class="text-gray-500 mb-6">
                Comienza creando tu primer sitio con nuestras plantillas
                optimizadas.
              </p>
              <a
                href="/create-site"
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700"
              >
                <i class="fas fa-plus mr-2"></i>
                Crear mi primer sitio
              </a>
            </div>

            <section class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">
                  Sitios más visitados
                </h2>
                <span class="text-sm text-gray-400"
                  >Basado en las estadísticas recientes</span
                >
              </div>
              <canvas id="topSitesChart" style="max-height: 320px"></canvas>
            </section>
          </div>

          <div id="usersManagementView" class="pt-6 px-4 space-y-10 hidden">
            <div class="max-w-6xl mx-auto space-y-10">
              <section class="wc-page-heading" data-hover-lift>
                <span class="wc-page-heading__eyebrow">Control granular</span>
                <h1 class="wc-page-heading__title">Usuarios y roles</h1>
                <p class="wc-page-heading__subtitle">
                  Administra permisos, estados y asignación de sitios desde un
                  panel diseñado para equipos de operaciones con grandes
                  volúmenes de datos.
                </p>
                <div class="wc-page-heading__actions">
                  <button
                    type="button"
                    id="umBackButton"
                    class="wc-button wc-button--ghost"
                    data-inline-module="dashboard"
                  >
                    <i class="fa-solid fa-arrow-left-long"></i>
                    Volver al dashboard
                  </button>
                </div>
              </section>

              <section class="wc-stats-grid">
                <article class="wc-stat-card" data-hover-lift>
                  <p class="wc-stat-card__label">Usuarios totales</p>
                  <p
                    class="wc-stat-card__value metric-value"
                    id="umMetricTotal"
                  >
                    0
                  </p>
                  <span class="wc-chip">En plataforma</span>
                </article>
                <article class="wc-stat-card" data-hover-lift>
                  <p class="wc-stat-card__label">Activos</p>
                  <p
                    class="wc-stat-card__value metric-value"
                    id="umMetricActive"
                  >
                    0
                  </p>
                  <span class="wc-chip wc-chip--success">Con acceso</span>
                </article>
                <article class="wc-stat-card" data-hover-lift>
                  <p class="wc-stat-card__label">Owners</p>
                  <p
                    class="wc-stat-card__value metric-value"
                    id="umMetricOwners"
                  >
                    0
                  </p>
                  <span class="wc-chip wc-chip--warning">Propietarios</span>
                </article>
              </section>

              <section class="wc-card" data-hover-lift>
                <div class="p-6 space-y-6">
                  <div class="wc-toolbar">
                    <div class="flex-1 max-w-lg relative">
                      <span
                        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400"
                        ><i class="fa-solid fa-magnifying-glass"></i
                      ></span>
                      <input
                        type="text"
                        id="umSearch"
                        class="wc-form-control pl-11"
                        placeholder="Buscar por nombre, correo o rol"
                      />
                    </div>
                    <div class="wc-toolbar__filters">
                      <span
                        class="text-xs uppercase tracking-[0.3em] text-slate-500"
                        >Filtros</span
                      >
                      <button
                        class="wc-filter-chip active"
                        type="button"
                        data-filter="all"
                      >
                        Todos
                      </button>
                      <button
                        class="wc-filter-chip"
                        type="button"
                        data-filter="owners"
                      >
                        Owners
                      </button>
                      <button
                        class="wc-filter-chip"
                        type="button"
                        data-filter="admins"
                      >
                        Admins
                      </button>
                      <button
                        class="wc-filter-chip"
                        type="button"
                        data-filter="suspended"
                      >
                        Suspendidos
                      </button>
                    </div>
                    <div>
                      <button
                        type="button"
                        id="umNewUserBtn"
                        class="wc-button wc-button--primary"
                      >
                        <i class="fas fa-user-plus"></i>
                        Nuevo usuario
                      </button>
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="wc-table">
                      <thead>
                        <tr>
                          <th>Usuario</th>
                          <th>Rol / Grupo</th>
                          <th>Estado</th>
                          <th>Activación</th>
                          <th>Expiración</th>
                          <th>Último acceso</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="umUsersTableBody">
                        <tr>
                          <td colspan="7">
                            <div class="wc-empty-state">
                              <h4>Sin usuarios aún</h4>
                              <p>
                                Cuando los registres aparecerán aquí con sus
                                métricas.
                              </p>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div
                    class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
                  >
                    <div class="flex items-center gap-2 text-sm text-slate-600">
                      <span>Ítems por página</span>
                      <select id="umPageSize" class="wc-form-control w-24">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                      </select>
                    </div>
                    <div class="flex items-center gap-3">
                      <span id="umPageInfo" class="text-sm text-slate-600"
                        >Mostrando 0 de 0 usuarios</span
                      >
                      <div class="flex gap-2">
                        <button
                          id="umPrevPageBtn"
                          class="table-action"
                          disabled
                        >
                          <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <button
                          id="umNextPageBtn"
                          class="table-action"
                          disabled
                        >
                          <i class="fa-solid fa-chevron-right"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>

            <div id="umDrawer" class="fixed inset-0 z-40 hidden">
              <div
                class="drawer-backdrop absolute inset-0 bg-slate-900/60"
              ></div>
              <div
                class="relative flex min-h-full items-start sm:items-center justify-center px-3 sm:px-6 py-6 sm:py-10"
              >
                <section class="modal-panel rounded-3xl">
                  <header
                    class="flex items-start justify-between border-b border-slate-100 px-6 py-5"
                  >
                    <div>
                      <p
                        class="text-xs uppercase tracking-[0.3em] text-blue-500"
                      >
                        Gestión de usuarios
                      </p>
                      <h2
                        id="umDrawerTitle"
                        class="mt-1 text-2xl font-semibold text-slate-900"
                      >
                        Nuevo Usuario
                      </h2>
                      <p class="mt-1 text-sm text-slate-500">
                        Completa la información para crear o actualizar la
                        cuenta.
                      </p>
                    </div>
                    <button
                      id="umCloseDrawerBtn"
                      class="rounded-full p-2 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600"
                      aria-label="Cerrar"
                    >
                      <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                  </header>

                  <div class="flex-1 overflow-y-auto px-6 py-6 space-y-6">
                    <div
                      class="rounded-2xl border border-blue-100 bg-blue-50/80 p-4 text-sm text-blue-900 flex gap-3"
                      data-hover-lift
                    >
                      <i
                        class="fa-solid fa-circle-info text-blue-500 text-xl"
                      ></i>
                      <div>
                        <p class="font-semibold">Consejo rápido</p>
                        <p class="text-blue-900/80">
                          Los Owners requieren un sitio asignado y tienen acceso
                          completo a su espacio; los Administradores pueden
                          gestionar múltiples sitios.
                        </p>
                      </div>
                    </div>

                    <div
                      id="umUserMetaSection"
                      class="hidden rounded-2xl border border-slate-100 bg-slate-50/70 p-4 text-sm text-slate-600 space-y-4"
                    >
                      <div class="grid gap-4 md:grid-cols-3">
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            ID interno
                          </p>
                          <p
                            id="umMetaId"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Rol asignado
                          </p>
                          <p
                            id="umMetaRole"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Sitio
                          </p>
                          <p
                            id="umMetaSite"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                      </div>
                      <div class="grid gap-4 md:grid-cols-3">
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Estado
                          </p>
                          <p
                            id="umMetaStatus"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Último acceso
                          </p>
                          <p
                            id="umMetaLastLogin"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Expira
                          </p>
                          <p
                            id="umMetaExpires"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                      </div>
                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Creado
                          </p>
                          <p
                            id="umMetaCreated"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                        <div>
                          <p
                            class="text-xs uppercase tracking-widest text-slate-400"
                          >
                            Actualizado
                          </p>
                          <p
                            id="umMetaUpdated"
                            class="mt-1 text-slate-900 font-semibold"
                          >
                            —
                          </p>
                        </div>
                      </div>
                      <div class="flex flex-col gap-2">
                        <p
                          class="text-xs uppercase tracking-widest text-slate-400"
                        >
                          Contraseña visible
                        </p>
                        <div class="flex flex-wrap items-center gap-2">
                          <code
                            id="umMetaPassword"
                            class="rounded-lg bg-white px-3 py-1 text-base font-semibold text-slate-800"
                            >—</code
                          >
                          <button
                            type="button"
                            id="umCopyPasswordBtn"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-white transition disabled:opacity-40"
                          >
                            <i class="fa-solid fa-copy"></i>
                            Copiar
                          </button>
                        </div>
                      </div>
                    </div>

                    <form id="umForm" class="space-y-6">
                      <div
                        class="rounded-2xl border border-slate-200 bg-white/70 p-4"
                        data-hover-lift
                      >
                        <div class="flex items-center gap-4">
                          <div
                            id="umAvatarPreview"
                            class="relative w-20 h-20 rounded-full bg-slate-200 text-slate-600 font-semibold text-lg flex items-center justify-center overflow-hidden ring-2 ring-white shadow-sm"
                          >
                            <img
                              id="umAvatarImage"
                              alt="Avatar de usuario"
                              class="hidden absolute inset-0 w-full h-full object-cover"
                            />
                            <span id="umAvatarInitials">NC</span>
                          </div>
                          <div class="flex-1 space-y-2">
                            <div>
                              <p class="text-sm font-semibold text-slate-800">
                                Foto de perfil
                              </p>
                              <p
                                class="text-xs text-slate-500"
                                id="umAvatarStatus"
                                data-default-message="Se mostrará en la tabla y en el panel administrativo."
                              >
                                Se mostrará en la tabla y en el panel
                                administrativo.
                              </p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                              <button
                                type="button"
                                id="umAvatarUploadBtn"
                                data-default-label="<i class='fa-solid fa-cloud-arrow-up'></i> Subir imagen"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50"
                              >
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                Subir imagen
                              </button>
                              <button
                                type="button"
                                id="umAvatarResetBtn"
                                class="inline-flex items-center gap-2 rounded-lg border border-transparent px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-700"
                              >
                                <i class="fa-solid fa-rotate-left"></i>
                                Quitar
                              </button>
                            </div>
                            <input
                              type="file"
                              id="umAvatarInput"
                              accept="image/*"
                              class="hidden"
                            />
                            <input
                              type="hidden"
                              id="umAvatarUrl"
                              name="avatar_url"
                            />
                          </div>
                        </div>
                      </div>

                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <label
                            for="umUsername"
                            class="text-sm font-medium text-slate-700"
                            >Nombre de usuario</label
                          >
                          <input
                            type="text"
                            id="umUsername"
                            name="username"
                            required
                            class="wc-form-control mt-1"
                            placeholder="ej. maria.campos"
                          />
                        </div>
                        <div>
                          <label
                            for="umEmail"
                            class="text-sm font-medium text-slate-700"
                            >Correo electrónico</label
                          >
                          <input
                            type="email"
                            id="umEmail"
                            name="email"
                            required
                            class="wc-form-control mt-1"
                            placeholder="usuario@webcontrol.com"
                          />
                        </div>
                      </div>

                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <label
                            for="umPassword"
                            class="text-sm font-medium text-slate-700"
                            >Contraseña</label
                          >
                          <input
                            type="password"
                            id="umPassword"
                            name="password"
                            required
                            class="wc-form-control mt-1"
                            placeholder="Mínimo 8 caracteres"
                          />
                          <p class="mt-1 text-xs text-slate-500">
                            Déjalo vacío para mantener la contraseña actual.
                          </p>
                        </div>
                        <div>
                          <label
                            for="umRole"
                            class="text-sm font-medium text-slate-700"
                            >Rol</label
                          >
                          <select
                            id="umRole"
                            name="role"
                            required
                            class="wc-form-control mt-1"
                          >
                            <option value="">Seleccionar rol</option>
                            <option value="owner">Owner</option>
                            <option value="admin">Administrador</option>
                          </select>
                        </div>
                      </div>

                      <div id="umSiteField" class="hidden">
                        <label
                          for="umSiteId"
                          class="text-sm font-medium text-slate-700"
                          >Sitio asignado</label
                        >
                        <select
                          id="umSiteId"
                          name="site_id"
                          class="wc-form-control mt-1"
                        >
                          <option value="">Seleccionar sitio</option>
                        </select>
                      </div>

                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <label
                            for="umExpiresAt"
                            class="text-sm font-medium text-slate-700"
                            >Fecha de expiración (opcional)</label
                          >
                          <input
                            type="datetime-local"
                            id="umExpiresAt"
                            name="expires_at"
                            class="wc-form-control mt-1"
                          />
                        </div>
                        <div
                          class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 mt-6 md:mt-8"
                        >
                          <input
                            type="checkbox"
                            id="umIsActive"
                            name="is_active"
                            checked
                            class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                          />
                          <div>
                            <label
                              for="umIsActive"
                              class="text-sm font-medium text-slate-800"
                              >Usuario activo</label
                            >
                            <p class="text-xs text-slate-500">
                              Desactiva el acceso temporalmente sin eliminar la
                              cuenta.
                            </p>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>

                  <footer
                    class="flex flex-col gap-3 border-t border-slate-100 bg-slate-50 px-6 py-4 sm:flex-row sm:justify-end"
                  >
                    <button
                      id="umCancelBtn"
                      type="button"
                      class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-white sm:w-auto"
                    >
                      Cancelar
                    </button>
                    <button
                      id="umSaveBtn"
                      type="button"
                      class="w-full rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 sm:w-auto"
                    >
                      Guardar
                    </button>
                  </footer>
                </section>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="/static/js/users-module.js"></script>
    <script>
      const API_URL = `${window.location.origin}/api`;
      let token = localStorage.getItem("token");
      let chart = null;

      const state = {
        sites: [],
        filteredSites: [],
        search: "",
        model: "all",
        view: "list",
      };

      const visitsCache = {};

      const dom = {
        toggleSidebarMobile: document.getElementById("toggleSidebarMobile"),
        sidebar: document.getElementById("sidebar"),
        sidebarBackdrop: document.getElementById("sidebarBackdrop"),
        userMenuButton: document.getElementById("userMenuButton"),
        userMenu: document.getElementById("userMenu"),
        userAvatar: document.getElementById("userAvatar"),
        userAvatarImage: document.getElementById("userAvatarImage"),
        userAvatarInitials: document.getElementById("userAvatarInitials"),
        sitesCard: document.getElementById("sitesCard"),
        emptyState: document.getElementById("emptyState"),
        searchInput: document.getElementById("searchInput"),
        modelFilter: document.getElementById("modelFilter"),
        exportButton: document.getElementById("exportCsvBtn"),
        viewButtons: document.querySelectorAll("[data-view-toggle]"),
        listView: document.getElementById("listView"),
        gridView: document.getElementById("gridView"),
        tableBody: document.getElementById("sitesTableBody"),
        mosaicGrid: document.getElementById("mosaicGrid"),
        ownerSiteSummary: document.getElementById("ownerSiteSummary"),
        ownerSiteShortcut: document.getElementById("ownerSiteShortcut"),
      };

      const roleVisibility = {
        ownerHidden: document.querySelectorAll("[data-owner-hidden]"),
        superadminOnly: document.querySelectorAll("[data-superadmin-only]"),
        ownerOnly: document.querySelectorAll("[data-owner-only]"),
      };

      const viewSections = {
        dashboard: document.getElementById("dashboardView"),
        users: document.getElementById("usersManagementView"),
      };

      const navLinks = {
        dashboard: document.querySelector('[data-nav-route="dashboard"]'),
        users: document.querySelector('[data-nav-route="users"]'),
      };

      const inlineNavLinks = document.querySelectorAll("[data-inline-module]");

      const initialView =
        document.body.dataset.initialView ||
        (window.location.pathname === "/users-management"
          ? "users"
          : "dashboard");

      let currentUserRole = localStorage.getItem("role") || null;
      let userInfoPromise = null;
      const usersModule = window.UsersModule || { activate: async () => {} };
      const viewController = createViewController(usersModule);

      if (!token) {
        window.location.href = "/";
      }

      initializeLayout();
      bindInteractions();
      applyRoleVisibility();
      setupInlineNavigation(viewController);

      userInfoPromise = loadUserInfo();
      viewController.show(initialView, { replaceHistory: true });
      refreshDashboard();

      function initializeLayout() {
        dom.toggleSidebarMobile.addEventListener("click", () => {
          dom.sidebar.classList.toggle("hidden");
          dom.sidebarBackdrop.classList.toggle("hidden");
        });

        dom.sidebarBackdrop.addEventListener("click", () => {
          dom.sidebar.classList.add("hidden");
          dom.sidebarBackdrop.classList.add("hidden");
        });

        dom.userMenuButton.addEventListener("click", (event) => {
          event.stopPropagation();
          dom.userMenu.classList.toggle("hidden");
        });

        document.addEventListener("click", (event) => {
          if (
            !dom.userMenu.contains(event.target) &&
            !dom.userMenuButton.contains(event.target)
          ) {
            dom.userMenu.classList.add("hidden");
          }
        });
      }

      function bindInteractions() {
        dom.searchInput.addEventListener("input", (event) => {
          state.search = event.target.value.toLowerCase();
          applyFilters();
        });

        dom.modelFilter.addEventListener("change", (event) => {
          state.model = event.target.value;
          applyFilters();
        });

        dom.exportButton.addEventListener("click", exportSitesToCsv);

        dom.viewButtons.forEach((button) => {
          button.addEventListener("click", () =>
            setView(button.dataset.viewToggle)
          );
        });

        setView(state.view);
      }

      function applyRoleVisibility() {
        const isOwner = currentUserRole === "owner";
        const isSuperadmin = currentUserRole === "superadmin";
        roleVisibility.ownerHidden.forEach((el) => {
          if (isOwner) {
            el.classList.add("hidden");
          } else {
            el.classList.remove("hidden");
          }
        });
        roleVisibility.superadminOnly.forEach((el) => {
          if (isSuperadmin) {
            el.classList.remove("hidden");
          } else {
            el.classList.add("hidden");
          }
        });
        roleVisibility.ownerOnly.forEach((el) => {
          if (isOwner) {
            el.classList.remove("hidden");
          } else {
            el.classList.add("hidden");
          }
        });
      }

      function updateOwnerShortcut(site = null) {
        if (!dom.ownerSiteShortcut || !dom.ownerSiteSummary) return;
        const fallbackSiteId = Number(localStorage.getItem("site_id") || 0);
        if (site) {
          dom.ownerSiteSummary.textContent = site.name
            ? `Gestionando: ${site.name}`
            : `ID asignado: ${site.id}`;
          dom.ownerSiteShortcut.href = `/editor/${site.id}`;
          dom.ownerSiteShortcut.classList.remove(
            "pointer-events-none",
            "opacity-60"
          );
          return;
        }

        if (fallbackSiteId > 0) {
          dom.ownerSiteSummary.textContent = `ID asignado: ${fallbackSiteId}. Cargando detalles del sitio...`;
          dom.ownerSiteShortcut.href = `/editor/${fallbackSiteId}`;
          dom.ownerSiteShortcut.classList.remove(
            "pointer-events-none",
            "opacity-60"
          );
        } else {
          dom.ownerSiteSummary.textContent = "Sin sitio asignado todavía.";
          dom.ownerSiteShortcut.href = "#";
          dom.ownerSiteShortcut.classList.add(
            "pointer-events-none",
            "opacity-60"
          );
        }
      }

      function formatNumber(num) {
        return num ? num.toLocaleString("es-ES") : "0";
      }

      function showNotification(message, type = "info") {
        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-yellow-500",
        };
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 ${
          colors[type] || "bg-gray-600"
        } text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      function escapeHtml(text = "") {
        return text
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function resolveAssetUrl(url = "") {
        if (!url) return "";
        const trimmed = url.trim();
        if (!trimmed) return "";
        if (/^https?:\/\//i.test(trimmed) || trimmed.startsWith("data:")) {
          return trimmed;
        }
        if (trimmed.startsWith("/")) {
          return trimmed;
        }
        return `/${trimmed}`;
      }

      function getInitials(name = "") {
        const raw = name.trim();
        if (!raw) return "WC";
        return raw
          .split(/\s+/)
          .map((part) => part.charAt(0))
          .join("")
          .slice(0, 2)
          .toUpperCase();
      }

      function updateCurrentUserAvatar(avatarUrl, username) {
        const container = dom.userAvatar;
        const img = dom.userAvatarImage;
        const initials = dom.userAvatarInitials;
        if (!container || !img || !initials) return;
        const resolved = resolveAssetUrl(avatarUrl || "");
        if (resolved) {
          img.src = resolved;
          img.classList.remove("hidden");
          initials.classList.add("hidden");
          container.classList.remove("bg-blue-600", "text-white");
          container.classList.add("bg-transparent");
        } else {
          img.classList.add("hidden");
          img.removeAttribute("src");
          initials.textContent = getInitials(username);
          initials.classList.remove("hidden");
          container.classList.add("bg-blue-600", "text-white");
          container.classList.remove("bg-transparent");
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function renderSiteLogo(site) {
        const logoSrc = resolveAssetUrl(site.logo_url);
        if (logoSrc) {
          return `
                <div class="site-logo rounded-xl overflow-hidden bg-white border border-gray-200 shadow-sm flex items-center justify-center">
                    <img src="${escapeHtml(logoSrc)}" alt="Logo ${escapeHtml(
            site.name || ""
          )}" loading="lazy">
                </div>
            `;
        }
        return `
            <div class="site-logo rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center border border-blue-100">
                <i class="fas fa-${getModelIcon(site.model_type)} text-lg"></i>
            </div>
        `;
      }

      async function loadUserInfo() {
        try {
          const response = await fetch(`${API_URL}/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) return;
          const data = await response.json();
          document.getElementById("userEmail").textContent = data.email;
          const username =
            data.username || (data.email ? data.email.split("@")[0] : "Admin");
          document.getElementById("userName").textContent = username;
          updateCurrentUserAvatar(data.avatar_url || "", username);
          currentUserRole = data.role || null;
          if (currentUserRole) {
            localStorage.setItem("role", currentUserRole);
          }
          if (data.site_id) {
            localStorage.setItem("site_id", data.site_id);
            if (currentUserRole === "owner") {
              updateOwnerShortcut();
            }
          } else if (currentUserRole === "owner") {
            updateOwnerShortcut();
          }
          applyRoleVisibility();
        } catch (error) {
          console.error("Error loading user info:", error);
        }
      }

      async function loadStats() {
        try {
          const response = await fetch(`${API_URL}/dashboard/stats`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) return;
          const stats = await response.json();
          document.getElementById("totalSites").textContent =
            stats.total_sites || 0;
          document.getElementById("publishedSites").textContent =
            stats.published_sites || 0;
          document.getElementById("draftSites").textContent = Math.max(
            (stats.total_sites || 0) - (stats.published_sites || 0),
            0
          );
          document.getElementById("totalViews").textContent =
            stats.total_visits || 0;
          if (stats.top_sites && stats.top_sites.length) {
            renderTopSitesChart(stats.top_sites);
          }
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadSites() {
        try {
          const response = await fetch(`${API_URL}/sites`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Respuesta inválida de /api/sites");
          state.sites = await response.json();

          if (currentUserRole === "owner") {
            const assignedId = Number(localStorage.getItem("site_id") || 0);
            const ownerSite =
              state.sites.find((site) => site.id === assignedId) ||
              state.sites[0] ||
              null;
            if (ownerSite) {
              updateOwnerShortcut(ownerSite);
            }
          }

          const hasSites = state.sites.length > 0;
          dom.sitesCard.classList.toggle("hidden", !hasSites);
          dom.emptyState.classList.toggle("hidden", hasSites);

          if (!hasSites) {
            dom.tableBody.innerHTML = "";
            dom.mosaicGrid.innerHTML = "";
            return;
          }

          applyFilters();
          state.sites.forEach((site) => loadSiteVisits(site.id));
        } catch (error) {
          console.error("Error loading sites:", error);
          dom.tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">No se pudieron cargar los sitios.</td></tr>`;
        }
      }

      function applyFilters() {
        const term = state.search.trim();
        state.filteredSites = state.sites.filter((site) => {
          const matchesModel =
            state.model === "all" || site.model_type === state.model;
          if (!matchesModel) return false;
          if (!term) return true;
          const haystack = [
            site.name,
            site.description,
            site.custom_domain,
            getModelName(site.model_type),
          ]
            .join(" ")
            .toLowerCase();
          return haystack.includes(term);
        });

        renderListView();
        renderGridView();
      }

      function renderListView() {
        if (!state.filteredSites.length) {
          dom.tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No encontramos sitios con ese criterio.</td></tr>`;
          return;
        }

        dom.tableBody.innerHTML = state.filteredSites
          .map((site) => {
            const liveUrl = getLiveUrl(site);
            const liveButton = liveUrl
              ? `<a href="${liveUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-link"></i> Ir al sitio</a>`
              : `<span class="text-gray-300 cursor-not-allowed"><i class="fas fa-link"></i> Ir al sitio</span>`;
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                ${renderSiteLogo(site)}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${escapeHtml(
                                  site.name || "Sin nombre"
                                )}</div>
                                <div class="text-sm text-gray-500 site-description" title="${escapeHtml(
                                  site.description || "Sin descripción"
                                )}">
                                    ${escapeHtml(
                                      site.description || "Sin descripción"
                                    )}
                                </div>
                                <div class="text-xs text-gray-400">${formatDate(
                                  site.updated_at
                                )}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${getModelName(site.model_type)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${
                          site.is_published
                            ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i> Publicado</span>'
                            : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-pencil-alt mr-1"></i> Borrador</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <i class="fas fa-eye mr-2 text-gray-400"></i>
                            <span data-visit-id="${site.id}">${
              formatNumber(visitsCache[site.id]) || "0"
            }</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <a href="/editor/${
                          site.id
                        }" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        ${liveButton}
                        ${(() => {
                          const label = site.is_published
                            ? "Replicar cambios"
                            : "Publicar";
                          return (
                            `<button data-publish-button="${site.id}" onclick="publishSite(${site.id})" class="text-green-600 hover:text-green-900 flex items-center gap-1">` +
                            `<i class="fas fa-upload"></i> ${label}</button>`
                          );
                        })()}
                        <button onclick="deleteSite(${
                          site.id
                        })" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      function renderGridView() {
        if (!state.filteredSites.length) {
          dom.mosaicGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 border border-dashed border-gray-200 rounded-xl p-8">No hay resultados para mostrar.</div>`;
          return;
        }

        dom.mosaicGrid.innerHTML = state.filteredSites
          .map((site) => {
            const preview = resolveAssetUrl(
              site.preview_image || site.hero_image || ""
            );
            const modelLabel = getModelName(site.model_type);
            return `
                <article class="mosaic-card rounded-2xl border border-gray-200 bg-white overflow-hidden flex flex-col">
                    <div class="h-44 bg-gray-100 relative">
                        ${
                          preview
                            ? `<img src="${escapeHtml(
                                preview
                              )}" alt="Vista previa de ${escapeHtml(
                                site.name || ""
                              )}" class="w-full h-full object-cover">`
                            : '<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">Sin miniatura</div>'
                        }
                        <div class="absolute top-3 left-3 px-3 py-1 rounded-full bg-white/90 text-xs font-semibold text-gray-700 border border-gray-200">
                            ${modelLabel}
                        </div>
                        <div class="absolute top-3 right-3 px-3 py-1 rounded-full ${
                          site.is_published
                            ? "bg-green-100 text-green-800"
                            : "bg-yellow-100 text-yellow-700"
                        } text-xs font-semibold">
                            ${site.is_published ? "Publicado" : "Borrador"}
                        </div>
                    </div>
                    <div class="p-5 flex flex-col gap-4 flex-1">
                        <div class="flex items-center gap-3">
                            ${renderSiteLogo(site)}
                            <div>
                                <p class="text-lg font-semibold text-gray-900">${escapeHtml(
                                  site.name || "Sin nombre"
                                )}</p>
                                <p class="text-xs text-gray-400">Actualizado ${formatDate(
                                  site.updated_at
                                )}</p>
                            </div>
                        </div>
                        <p class="text-sm mosaic-description">${escapeHtml(
                          site.description || "Sin descripción registrada."
                        )}</p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            ${renderSocialChips(site)}
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <i class="fas fa-chart-line"></i>
                            <span data-visit-id="${site.id}">${
              formatNumber(visitsCache[site.id]) || "0"
            } visitas</span>
                        </div>
                        ${renderGridActions(site)}
                    </div>
                </article>
            `;
          })
          .join("");
      }

      function renderGridActions(site) {
        const liveUrl = getLiveUrl(site);
        const publishLabel = site.is_published ? "Replicar" : "Publicar";
        return `
            <div class="mt-auto flex flex-wrap gap-2 text-sm font-semibold">
                <a href="/editor/${
                  site.id
                }" class="px-3 py-2 rounded-lg bg-gray-900 text-white">Editar</a>
                ${
                  liveUrl
                    ? `<a href="${liveUrl}" target="_blank" class="px-3 py-2 rounded-lg border border-blue-200 text-blue-600">Ir al sitio</a>`
                    : `<span class="px-3 py-2 rounded-lg border border-blue-100 text-blue-200 cursor-not-allowed">Ir al sitio</span>`
                }
                <button data-publish-button="${site.id}" onclick="publishSite(${
          site.id
        })" class="px-3 py-2 rounded-lg border border-green-200 text-green-600 flex items-center gap-2"><i class="fas fa-upload"></i>${publishLabel}</button>
                <button onclick="deleteSite(${
                  site.id
                })" class="px-3 py-2 rounded-lg border border-red-200 text-red-600">Eliminar</button>
            </div>
        `;
      }

      function renderSocialChips(site) {
        const chips = [];
        if (site.facebook_url)
          chips.push(
            `<a href="${site.facebook_url}" target="_blank" class="social-chip"><i class="fab fa-facebook-f"></i>Facebook</a>`
          );
        if (site.instagram_url)
          chips.push(
            `<a href="${site.instagram_url}" target="_blank" class="social-chip"><i class="fab fa-instagram"></i>Instagram</a>`
          );
        if (site.tiktok_url)
          chips.push(
            `<a href="${site.tiktok_url}" target="_blank" class="social-chip"><i class="fab fa-tiktok"></i>TikTok</a>`
          );
        if (site.whatsapp_number)
          chips.push(
            `<a href="${getWhatsappLink(
              site.whatsapp_number
            )}" target="_blank" class="social-chip"><i class="fab fa-whatsapp"></i>WhatsApp</a>`
          );
        return chips.length
          ? chips.join("")
          : '<span class="text-xs text-gray-400">Sin redes vinculadas</span>';
      }

      function getWhatsappLink(number) {
        const digits = (number || "").replace(/[^0-9]/g, "");
        return digits ? `https://wa.me/${digits}` : "#";
      }

      function getLiveUrl(site) {
        if (site.custom_domain) {
          return site.custom_domain.startsWith("http")
            ? site.custom_domain
            : `https://${site.custom_domain}`;
        }
        if (site.github_url) {
          const normalized = site.github_url.trim();
          if (!normalized) return "";
          return /^https?:\/\//i.test(normalized)
            ? normalized
            : `https://${normalized.replace(/^\/+/, "")}`;
        }
        return "";
      }

      function setView(view) {
        state.view = view;
        dom.viewButtons.forEach((button) => {
          const isActive = button.dataset.viewToggle === view;
          button.classList.toggle("bg-gray-900", isActive);
          button.classList.toggle("text-white", isActive);
          button.classList.toggle("bg-white", !isActive);
          button.classList.toggle("text-gray-600", !isActive);
        });
        dom.listView.classList.toggle("hidden", view !== "list");
        dom.gridView.classList.toggle("hidden", view !== "grid");
      }

      async function loadSiteVisits(siteId) {
        try {
          const response = await fetch(`${API_URL}/stats/${siteId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) return;
          const data = await response.json();
          visitsCache[siteId] = data.total_visits || 0;
          updateVisitBadges(siteId);
        } catch (error) {
          console.error(`Error loading visits for site ${siteId}:`, error);
        }
      }

      function updateVisitBadges(siteId) {
        document
          .querySelectorAll(`[data-visit-id="${siteId}"]`)
          .forEach((element) => {
            element.textContent = formatNumber(visitsCache[siteId] || 0);
          });
      }

      function setPublishLoading(siteId, isLoading) {
        document
          .querySelectorAll(`[data-publish-button="${siteId}"]`)
          .forEach((button) => {
            if (isLoading) {
              button.setAttribute("disabled", "disabled");
              button.classList.add("opacity-60", "cursor-wait");
            } else {
              button.removeAttribute("disabled");
              button.classList.remove("opacity-60", "cursor-wait");
            }
          });
      }

      async function publishSite(siteId) {
        const confirmed = await confirmAction(
          "¿Estás seguro de publicar este sitio en GitHub Pages?",
          {
            title: "Publicar sitio",
            icon: "info",
            confirmText: "Sí, publicar",
          }
        );
        if (!confirmed) return;
        showNotification("Publicando sitio...", "info");
        setPublishLoading(siteId, true);
        try {
          const response = await fetch(`${API_URL}/sites/${siteId}/publish`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();
          if (response.ok) {
            showNotification(
              data.message || "Sitio publicado exitosamente",
              "success"
            );
            await refreshDashboard();
          } else {
            showNotification(
              data.detail || "Error al publicar el sitio",
              "error"
            );
          }
        } catch (error) {
          console.error("Error publishing site:", error);
          showNotification("Error al publicar sitio", "error");
        } finally {
          setPublishLoading(siteId, false);
        }
      }

      async function deleteSite(siteId) {
        const confirmed = await confirmAction(
          "¿Estás seguro de que quieres eliminar este sitio? Esta acción no se puede deshacer.",
          {
            title: "Eliminar sitio",
            icon: "warning",
            confirmText: "Sí, eliminar",
          }
        );
        if (!confirmed) return;
        try {
          const response = await fetch(`${API_URL}/sites/${siteId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (response.ok) {
            showNotification("Sitio eliminado exitosamente", "success");
            await refreshDashboard();
          } else {
            showNotification("Error al eliminar sitio", "error");
          }
        } catch (error) {
          console.error("Error deleting site:", error);
          showNotification("Error al eliminar el sitio", "error");
        }
      }

      function setupInlineNavigation(controller) {
        inlineNavLinks.forEach((link) => {
          link.addEventListener("click", async (event) => {
            event.preventDefault();
            const target = link.dataset.inlineModule;
            if (!target) return;
            await controller.show(target);
          });
        });
      }

      function createViewController(usersModuleInstance) {
        const routes = {
          dashboard: "/dashboard",
          users: "/users-management",
        };

        async function show(target, options = {}) {
          let nextView = routes[target] ? target : "dashboard";

          if (nextView === "users") {
            await userInfoPromise;
            if ((currentUserRole || "").toLowerCase() !== "superadmin") {
              showNotification(
                "Solo los superadministradores pueden acceder a Gestión de usuarios.",
                "warning"
              );
              nextView = "dashboard";
            } else {
              await usersModuleInstance.activate();
            }
          }

          Object.entries(viewSections).forEach(([key, element]) => {
            if (!element) return;
            element.classList.toggle("hidden", key !== nextView);
          });

          Object.entries(navLinks).forEach(([key, link]) => {
            if (!link) return;
            const isActive = key === nextView;
            link.classList.toggle("bg-gray-100", isActive);
            link.classList.toggle("text-gray-900", isActive);
          });

          if (!options.skipHistory) {
            const path = routes[nextView];
            const state = { view: nextView };
            if (options.replaceHistory) {
              window.history.replaceState(state, "", path);
            } else {
              window.history.pushState(state, "", path);
            }
          }

          window.scrollTo({ top: 0, behavior: "auto" });
        }

        window.addEventListener("popstate", (event) => {
          const desired =
            (event.state && event.state.view) ||
            (window.location.pathname === "/users-management"
              ? "users"
              : "dashboard");
          show(desired, { skipHistory: true, replaceHistory: true });
        });

        return { show };
      }

      function exportSitesToCsv() {
        if (!state.filteredSites.length) {
          showNotification("No hay datos para exportar.", "warning");
          return;
        }
        const headers = [
          "ID",
          "Nombre",
          "Descripción",
          "Modelo",
          "Estado",
          "Dominio",
          "GitHub",
          "Facebook",
          "Instagram",
          "TikTok",
          "WhatsApp",
          "Visitas",
          "Creado",
          "Actualizado",
        ];
        const rows = state.filteredSites.map((site) => [
          site.id,
          site.name,
          site.description || "",
          getModelName(site.model_type),
          site.is_published ? "Publicado" : "Borrador",
          site.custom_domain || "",
          site.github_url || "",
          site.facebook_url || "",
          site.instagram_url || "",
          site.tiktok_url || "",
          site.whatsapp_number || "",
          visitsCache[site.id] || 0,
          site.created_at,
          site.updated_at,
        ]);

        const csvContent = [headers, ...rows]
          .map((row) =>
            row.map((cell) => `"${String(cell).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `webcontrol_sites_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
        URL.revokeObjectURL(url);
        showNotification("Exportación completada.", "success");
      }

      function getModelIcon(modelType) {
        const icons = {
          artesanias: "palette",
          cocina: "utensils",
          belleza: "cut",
          adecuaciones: "tools",
          chivos: "paw",
        };
        return icons[modelType] || "globe";
      }

      function getModelName(modelType) {
        const names = {
          artesanias: "Artesanías",
          cocina: "Cocina",
          belleza: "Belleza",
          adecuaciones: "Adecuaciones",
          chivos: "Ganadería",
        };
        return names[modelType] || modelType || "Modelo";
      }

      function renderTopSitesChart(topSites) {
        const ctx = document.getElementById("topSitesChart");
        if (!ctx) return;
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: topSites.map((s) => s.name),
            datasets: [
              {
                label: "Visitas",
                data: topSites.map((s) => s.visits),
                backgroundColor: "#3B82F6",
                borderRadius: 8,
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1, font: { size: 12 } },
                grid: { color: "rgba(0,0,0,0.05)" },
              },
              x: {
                ticks: { font: { size: 12 } },
                grid: { display: false },
              },
            },
          },
        });
      }

      async function refreshDashboard() {
        await Promise.all([loadStats(), loadSites()]);
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("email");
        localStorage.removeItem("role");
        localStorage.removeItem("site_id");
        localStorage.removeItem("user_payload");
        window.location.href = "/";
      }
    </script>
  </body>
</html>
