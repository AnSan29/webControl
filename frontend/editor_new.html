<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/static/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/webcontrol-logo.png" />
  <link rel="icon" type="image/svg+xml" href="/static/img/webcontrol-logo.svg" />
  <link rel="shortcut icon" href="/static/img/webcontrol-logo.png" />
  <link rel="apple-touch-icon" href="/static/img/webcontrol-logo.png" />
  <script>
    let currentSiteId = null;
    let chart = null;
    let editorPaletteSelect = null;
    let editorPalettePreview = null;
    let currentModelType = null;
    window.productsData = [];
    window.galleryData = [];
    const LOCAL_ASSET_HOSTS = new Set(["localhost", "127.0.0.1"]);

    function canonicalizeAssetUrl(value) {
      if (!value || typeof value !== "string") return "";
      let trimmed = value.trim();
      if (!trimmed) return "";
      if (/^data:/i.test(trimmed)) return trimmed;
      if (trimmed.startsWith("./")) trimmed = trimmed.replace(/^\.\/+/, "");
      if (trimmed.startsWith("images/")) return trimmed;
      if (trimmed.startsWith("/images/")) return trimmed.replace(/^\/+/, "");
      if (/^https?:\/\//i.test(trimmed) || trimmed.startsWith("//")) {
        try {
          const parsed = new URL(trimmed, window.location.origin);
          if (LOCAL_ASSET_HOSTS.has(parsed.hostname) && parsed.pathname.startsWith("/images/")) {
            return parsed.pathname.replace(/^\/+/, "");
          }
        } catch (error) {
          return trimmed;
        }
        return trimmed;
      }
      return trimmed;
    }

    function resolvePreviewAssetUrl(value) {
      const canonical = canonicalizeAssetUrl(value);
      if (!canonical) return "";
      if (/^(data:|https?:|\/\/)/i.test(canonical)) return canonical;
      const relative = canonical.replace(/^\/+/, "");
      if (!relative) return "";
      if (relative.startsWith("images/")) return `/images/${relative.slice(7)}`;
      return `/${relative}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      editorPaletteSelect = document.getElementById("editorPaletteSelect");
      editorPalettePreview = document.getElementById("editorPalettePreview");
      setupEditorInteractions();
      setupEditorPaletteListener();
      loadSite();
    });

    function setupEditorInteractions() {
      const btn = document.getElementById("editorMenuButton");
      const menu = document.getElementById("editorUserMenu");
      btn?.addEventListener("click", (event) => {
        event.stopPropagation();
        menu?.classList.toggle("hidden");
      });
      window.addEventListener("click", (event) => {
        if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
          menu.classList.add("hidden");
        }
      });
      const storedEmail = localStorage.getItem("email");
      if (storedEmail) {
        const name = storedEmail.split("@")[0];
        document.getElementById("editorUserName").textContent = name;
        document.getElementById("editorUserEmail").textContent = storedEmail;
      }
    }

    function setupEditorPaletteListener() {
      editorPaletteSelect?.addEventListener("change", () => {
        if (!currentModelType) return;
        const selectedPalette = findPaletteForModel(currentModelType, editorPaletteSelect.value);
        if (selectedPalette) {
          applyPaletteToInputs(selectedPalette);
          renderEditorPalettePreview(selectedPalette);
        }
      });
    }

    function renderEditorPalettePreview(palette) {
      if (!editorPalettePreview) return;
      if (!palette) {
        editorPalettePreview.innerHTML = '<p class="text-xs text-slate-400 col-span-4">Sin paleta disponible.</p>';
        return;
      }
      const items = [
        { label: "Primario", value: palette.primary },
        { label: "Secundario", value: palette.secondary },
        { label: "Acento", value: palette.accent },
        { label: "Fondo", value: palette.background },
      ].filter((item) => item.value);
      editorPalettePreview.innerHTML = items
        .map((item) => `<div class="editor-palette-dot" style="background:${item.value}"><span class="sr-only">${item.label}</span></div>`)
        .join("");
    }

    function applyPaletteToInputs(palette) {
      const primaryInput = document.getElementById("primary_color");
      const secondaryInput = document.getElementById("secondary_color");
      if (!primaryInput || !secondaryInput || !palette) return;
      if (palette.primary) {
        primaryInput.value = palette.primary;
        updateColorPreview("primary");
      }
      if (palette.secondary) {
        secondaryInput.value = palette.secondary;
        updateColorPreview("secondary");
      }
    }

    function hydrateEditorPalette(modelType) {
      currentModelType = modelType;
      if (!editorPaletteSelect) return;
      const palettes = getPalettesForModel(modelType) || [];
      if (!palettes.length) {
        editorPaletteSelect.disabled = true;
        editorPaletteSelect.innerHTML = '<option value="">Sin paletas predefinidas</option>';
        renderEditorPalettePreview({
          primary: document.getElementById("primary_color")?.value,
          secondary: document.getElementById("secondary_color")?.value,
        });
        return;
      }
      editorPaletteSelect.disabled = false;
      editorPaletteSelect.innerHTML = palettes.map((palette) => `<option value="${palette.id}">${palette.label}</option>`).join("");
      const currentPrimary = document.getElementById("primary_color")?.value?.toUpperCase();
      const currentSecondary = document.getElementById("secondary_color")?.value?.toUpperCase();
      const matched =
        palettes.find((palette) => palette.primary.toUpperCase() === currentPrimary && palette.secondary.toUpperCase() === currentSecondary) ||
        palettes[0];
      editorPaletteSelect.value = matched.id;
      renderEditorPalettePreview(matched);
    }

    async function loadSite() {
      const isAuth = await checkAuth();
      if (!isAuth) return;
      const path = window.location.pathname;
      currentSiteId = path.split("/").pop();
      try {
        const response = await fetchAPI(`/api/sites/${currentSiteId}`);
        const site = await response.json();
        currentModelType = site.model_type;
        document.getElementById("siteName").textContent = site.name || "Editor";
        document.getElementById("breadcrumbSite").textContent = site.name || "Sitio";
        document.getElementById("name").value = site.name || "";
        document.getElementById("description").value = site.description || "";
        document.getElementById("hero_title").value = site.hero_title || "";
        document.getElementById("hero_subtitle").value = site.hero_subtitle || "";
        document.getElementById("hero_image").value = canonicalizeAssetUrl(site.hero_image || "");
        document.getElementById("about_text").value = site.about_text || "";
        document.getElementById("about_image").value = canonicalizeAssetUrl(site.about_image || "");
        document.getElementById("contact_email").value = site.contact_email || "";
        document.getElementById("contact_phone").value = site.contact_phone || "";
        document.getElementById("whatsapp_number").value = site.whatsapp_number || "";
        document.getElementById("contact_address").value = site.contact_address || "";
        document.getElementById("facebook_url").value = site.facebook_url || "";
        document.getElementById("instagram_url").value = site.instagram_url || "";
        document.getElementById("tiktok_url").value = site.tiktok_url || "";
        document.getElementById("primary_color").value = site.primary_color || "#3B82F6";
        document.getElementById("secondary_color").value = site.secondary_color || "#8B5CF6";
        document.getElementById("logo_url").value = canonicalizeAssetUrl(site.logo_url || "");
        document.getElementById("custom_domain").value = site.custom_domain || "";
        loadProductCards(site.products_json);
        loadGalleryImages(site.gallery_images);
        updateImagePreview("hero_image", "heroImagePreview");
        updateImagePreview("about_image", "aboutImagePreview");
        updateColorPreview("primary");
        updateColorPreview("secondary");
        hydrateEditorPalette(site.model_type);
        const syncStatus = document.getElementById("syncStatus");
        site.is_published ? syncStatus.classList.remove("hidden") : syncStatus.classList.add("hidden");
        document.getElementById("siteModelTag").textContent = getModelName(site.model_type);
        document.getElementById("siteStateTag").textContent = site.is_published ? "Publicado" : "Borrador";
        await loadStats(site);
        updateEditorMetrics();
      } catch (error) {
        console.error("Error loading site:", error);
        showNotification("Error al cargar sitio", "error");
      }
    }

    function updateEditorMetrics() {
      document.getElementById("metricProducts").textContent = window.productsData.length;
      document.getElementById("metricGallery").textContent = window.galleryData.length;
      document.getElementById("metricSections").textContent = 9 + window.productsData.length;
    }

    async function saveSite() {
      const formData = new FormData(document.getElementById("editorForm"));
      const data = Object.fromEntries(formData);
      data.products_json = JSON.stringify(window.productsData || []);
      data.gallery_images = JSON.stringify(window.galleryData || []);
      try {
        const response = await fetchAPI(`/api/sites/${currentSiteId}`, {
          method: "PUT",
          body: JSON.stringify(data),
        });
        if (response.ok) {
          showNotification("Cambios guardados", "success");
          try {
            const siteResponse = await fetchAPI(`/api/sites/${currentSiteId}`);
            if (siteResponse?.ok) {
              const siteData = await siteResponse.json();
              if (siteData.is_published) {
                showNotification(
                  "Los cambios se guardaron. Publica nuevamente para actualizar GitHub Pages.",
                  "info"
                );
              }
            }
          } catch (error) {
            console.warn("No se pudo verificar estado de publicación", error);
          }
        } else {
          showNotification("Error al guardar", "error");
        }
      } catch (error) {
        console.error("Error saving:", error);
        showNotification("Error al guardar", "error");
      }
    }

    async function publishSite() {
      const confirmed = await confirmAction("¿Deseas publicar este sitio en GitHub Pages?", {
        title: "Publicar sitio",
        icon: "info",
        confirmText: "Sí, publicar",
      });
      if (!confirmed) return;
      showNotification("Publicando sitio...", "info");
      try {
        const response = await fetchAPI(`/api/sites/${currentSiteId}/publish`, { method: "POST" });
        const data = await response.json();
        if (response.ok) {
          showNotification("Sitio publicado", "success");
          document.getElementById("syncStatus").classList.remove("hidden");
          if (data.info) setTimeout(() => showNotification(data.info, "info"), 1500);
          if (data.warning) setTimeout(() => showNotification(data.warning, "warning"), 3000);
          if (data.url) setTimeout(() => window.open(data.url, "_blank"), 4000);
        } else {
          showNotification(data.detail || "Error al publicar", "error");
        }
      } catch (error) {
        console.error("Error publishing:", error);
        showNotification("Error al publicar", "error");
      }
    }

    async function loadStats(siteData = null) {
      try {
        const response = await fetchAPI(`/api/stats/${currentSiteId}`);
        const data = await response.json();
        document.getElementById("totalVisits").textContent = formatNumber(data.total_visits);
        const ctx = document.getElementById("visitsChart");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.visits_by_day.map((v) => new Date(v.date).toLocaleDateString("es-ES", { month: "short", day: "numeric" })),
            datasets: [
              {
                label: "Visitas",
                data: data.visits_by_day.map((v) => v.visits),
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.15)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
          },
        });
        const siteResponse = siteData ? { json: async () => siteData } : await fetchAPI(`/api/sites/${currentSiteId}`);
        const site = siteData || (await siteResponse.json());
        document.getElementById("siteInfo").innerHTML = `
          <p><strong>Modelo:</strong> ${getModelIcon(site.model_type)} ${getModelName(site.model_type)}</p>
          <p><strong>Estado:</strong> ${site.is_published ? '<span class="wc-mini-chip" style="color:#16a34a">Publicado</span>' : '<span class="wc-mini-chip">Borrador</span>'}</p>
          ${site.github_url ? `<p><strong>URL:</strong> <a href="${site.github_url}" target="_blank" class="text-blue-600">${site.github_url}</a></p>` : ""}
          <p><strong>Creado:</strong> ${formatDate(site.created_at)}</p>
          <p><strong>Actualizado:</strong> ${formatDate(site.updated_at)}</p>
        `;
        document.getElementById("siteState").textContent = site.is_published ? "Publicado" : "Borrador";
        document.getElementById("siteModel").textContent = getModelName(site.model_type);
      } catch (error) {
        console.error("Error loading stats:", error);
      }
    }

    function showTab(tab) {
      const contentTab = document.getElementById("editorForm");
      const statsTab = document.getElementById("statsTab");
      const contentBtn = document.getElementById("tab-content");
      const statsBtn = document.getElementById("tab-stats");
      if (tab === "content") {
        contentTab.classList.remove("hidden");
        statsTab.classList.add("hidden");
        contentBtn.classList.add("active");
        statsBtn.classList.remove("active");
      } else {
        contentTab.classList.add("hidden");
        statsTab.classList.remove("hidden");
        statsBtn.classList.add("active");
        contentBtn.classList.remove("active");
        loadStats();
      }
    }

    function updateImagePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      if (!input || !preview) return;
      const canonical = canonicalizeAssetUrl(input.value || "");
      if (input.value !== canonical) input.value = canonical;
      const previewUrl = resolvePreviewAssetUrl(canonical);
      if (previewUrl) {
        preview.style.backgroundImage = `url('${previewUrl}')`;
        preview.classList.add("has-image");
        preview.textContent = "";
      } else {
        preview.style.backgroundImage = "";
        preview.classList.remove("has-image");
        preview.textContent = "Previsualización";
      }
    }

    function updateColorPreview(type) {
      const colorInput = document.getElementById(`${type}_color`);
      const previewBox = document.getElementById(`${type}ColorPreview`);
      const demoButton = document.getElementById(`demoButton${type.charAt(0).toUpperCase() + type.slice(1)}`);
      const color = colorInput.value;
      previewBox.querySelector(".w-full").style.backgroundColor = color;
      demoButton.style.backgroundColor = color;
      demoButton.style.borderColor = color;
      demoButton.style.color = type === "secondary" ? "#0f172a" : "#fff";
    }

    function loadProductCards(productsJson) {
      document.getElementById("productsSkeleton").classList.add("hidden");
      try {
        const products = productsJson ? JSON.parse(productsJson) : [];
        const parsedProducts = Array.isArray(products) ? products : [];
        window.productsData = parsedProducts
          .filter((product) => product && typeof product === "object")
          .map((product) => ({ ...product, image: canonicalizeAssetUrl(product.image || "") }));
        renderProducts();
      } catch (e) {
        console.error("Error parsing products:", e);
        window.productsData = [];
        renderProducts();
      }
    }

    function renderProducts() {
      const container = document.getElementById("productsContainer");
      const emptyState = document.getElementById("productsEmpty");
      const productsTextarea = document.getElementById("products_json");
      if (!window.productsData || window.productsData.length === 0) {
        container.innerHTML = "";
        emptyState.classList.remove("hidden");
        productsTextarea.value = "[]";
        updateEditorMetrics();
        return;
      }
      emptyState.classList.add("hidden");
      container.innerHTML = window.productsData
        .map((product, index) => {
          const sanitizedImage = canonicalizeAssetUrl(product.image || "");
          if (product.image !== sanitizedImage) {
            window.productsData[index].image = sanitizedImage;
          }
          const previewImage = sanitizedImage ? resolvePreviewAssetUrl(sanitizedImage) : "";
          const backgroundImage = previewImage || "https://via.placeholder.com/400x300?text=Sin+Imagen";
          return `
            <div class="border border-slate-100 rounded-2xl p-4 shadow-sm bg-white" data-hover-lift>
              <div class="relative rounded-2xl overflow-hidden h-48 mb-4 bg-slate-100" style="background-image:url('${backgroundImage}'); background-size:cover; background-position:center;">
                <button type="button" class="absolute top-3 right-3 bg-white/90 text-slate-700 px-3 py-1 text-xs font-semibold rounded-full" onclick="deleteProduct(${index})">
                  <i class="fas fa-trash mr-1"></i>Eliminar
                </button>
              </div>
              <input type="text" class="wc-field__input mb-3" value="${product.name || ""}" placeholder="Nombre" onchange="updateProduct(${index}, 'name', this.value)">
              <textarea class="wc-field__textarea mb-3" placeholder="Descripción" onchange="updateProduct(${index}, 'description', this.value)">${product.description || ""}</textarea>
              <input type="text" class="wc-field__input mb-3" value="${product.price || ""}" placeholder="Precio" onchange="updateProduct(${index}, 'price', this.value)">
              <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('product_image_${index}').click()" class="wc-button wc-button--ghost flex-1">
                  <i class="fas fa-upload"></i> Subir
                </button>
                <button type="button" onclick="toggleProductUrlInput(${index})" class="wc-button wc-button--ghost flex-1">
                  <i class="fas fa-link"></i> URL
                </button>
              </div>
              <input type="file" id="product_image_${index}" accept="image/*" class="hidden" onchange="uploadProductImage(this, ${index})">
              <input type="url" id="product_url_${index}" class="wc-field__input mt-3 hidden" value="${sanitizedImage}" placeholder="https://imagen.com" onchange="updateProduct(${index}, 'image', this.value)">
            </div>
          `;
        })
        .join("");
      productsTextarea.value = JSON.stringify(window.productsData);
      updateEditorMetrics();
    }

    function addNewProduct() {
      window.productsData.push({
        name: "Nuevo Producto",
        description: "Describe tu producto aquí",
        price: "0",
        image: "https://via.placeholder.com/400x300?text=Agregar+Imagen",
      });
      renderProducts();
      showNotification("Producto agregado", "success");
    }

    function updateProduct(index, field, value) {
      if (window.productsData[index]) {
        if (field === "image") {
          window.productsData[index][field] = canonicalizeAssetUrl(value);
          renderProducts();
        } else {
          window.productsData[index][field] = value;
        }
        updateEditorMetrics();
      }
    }

    function deleteProduct(index) {
      confirmAction("¿Eliminar este producto?", {
        title: "Eliminar producto",
        icon: "warning",
        confirmText: "Sí, eliminar",
      }).then((confirmed) => {
        if (!confirmed) return;
        window.productsData.splice(index, 1);
        renderProducts();
        showNotification("Producto eliminado", "success");
      });
    }

    function loadGalleryImages(galleryJson) {
      document.getElementById("gallerySkeleton").classList.add("hidden");
      try {
        const images = galleryJson ? JSON.parse(galleryJson) : [];
        window.galleryData = (Array.isArray(images) ? images : []).map((imageUrl) => canonicalizeAssetUrl(typeof imageUrl === "string" ? imageUrl : ""));
        renderGallery();
      } catch (e) {
        console.error("Error parsing gallery:", e);
        window.galleryData = [];
        renderGallery();
      }
    }

    function renderGallery() {
      const container = document.getElementById("galleryContainer");
      const emptyState = document.getElementById("galleryEmpty");
      const galleryTextarea = document.getElementById("gallery_images_input");
      if (!window.galleryData || window.galleryData.length === 0) {
        container.innerHTML = "";
        emptyState.classList.remove("hidden");
        galleryTextarea.value = "[]";
        updateEditorMetrics();
        return;
      }
      emptyState.classList.add("hidden");
      container.innerHTML = window.galleryData
        .map((imageUrl, index) => {
          const sanitizedUrl = canonicalizeAssetUrl(imageUrl || "");
          if (window.galleryData[index] !== sanitizedUrl) {
            window.galleryData[index] = sanitizedUrl;
          }
          const previewUrl = resolvePreviewAssetUrl(sanitizedUrl) || "https://via.placeholder.com/400x300?text=Sin+imagen";
          return `
            <div class="border border-slate-100 rounded-2xl p-4 shadow-sm bg-white" data-hover-lift>
              <div class="relative rounded-2xl overflow-hidden h-40 mb-3 bg-slate-100" style="background-image:url('${previewUrl}'); background-size:cover; background-position:center;">
                <button type="button" class="absolute top-3 right-3 bg-white/90 text-slate-700 px-3 py-1 text-xs font-semibold rounded-full" onclick="deleteGalleryImage(${index})">
                  <i class="fas fa-trash mr-1"></i>Eliminar
                </button>
              </div>
              <input type="url" class="wc-field__input" value="${sanitizedUrl}" placeholder="https://imagen.com" onchange="updateGalleryImage(${index}, this.value)">
            </div>
          `;
        })
        .join("");
      galleryTextarea.value = JSON.stringify(window.galleryData);
      updateEditorMetrics();
    }

    async function addNewGalleryImage() {
      const wantsUpload = await confirmAction("¿Deseas subir una imagen desde tu computadora?", {
        title: "Agregar imagen",
        icon: "question",
        confirmText: "Subir archivo",
        cancelText: "Usar URL",
      });
      if (wantsUpload) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (file) await uploadGalleryImage(file);
        };
        input.click();
      } else {
        const url = await requestInput({
          title: "Ingresa la URL de la imagen",
          inputValue: "https://",
          placeholder: "https://tusitio.com/imagen.jpg",
        });
        if (url && url.trim() !== "https://") {
          window.galleryData.push(canonicalizeAssetUrl(url.trim()));
          renderGallery();
          showNotification("Imagen agregada", "success");
        }
      }
    }

    function updateGalleryImage(index, value) {
      if (window.galleryData[index] !== undefined) {
        window.galleryData[index] = canonicalizeAssetUrl(value);
        renderGallery();
      }
    }

    function deleteGalleryImage(index) {
      confirmAction("¿Eliminar esta imagen?", {
        title: "Eliminar imagen",
        icon: "warning",
        confirmText: "Sí, eliminar",
      }).then((confirmed) => {
        if (!confirmed) return;
        window.galleryData.splice(index, 1);
        renderGallery();
        showNotification("Imagen eliminada", "success");
      });
    }

    function addProductTemplate() {
      window.productsData = window.productsData || [];
      window.productsData.push({
        name: "Producto Ejemplo",
        description: "Descripción del producto",
        price: "50000",
        image: "https://via.placeholder.com/400x300",
      });
      renderProducts();
      showNotification("Producto de ejemplo agregado", "success");
    }

    async function uploadImage(fileInput, targetInputId, previewId) {
      const file = fileInput.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        showNotification("Selecciona una imagen válida", "error");
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showNotification("La imagen es muy grande. Máximo 5MB", "error");
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("site_id", currentSiteId);
      try {
        showNotification("Subiendo imagen...", "info");
        const response = await fetchAPI("/api/upload-image", {
          method: "POST",
          body: formData,
          headers: {},
        });
        const data = await response.json();
        if (data.success) {
          const urlInput = document.getElementById(targetInputId);
          const canonicalUrl = canonicalizeAssetUrl(data.url);
          urlInput.value = canonicalUrl;
          updateImagePreview(targetInputId, previewId);
          showNotification("✅ Imagen subida", "success");
        } else {
          showNotification("Error al subir imagen", "error");
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification("Error al subir imagen", "error");
      }
    }

    async function uploadProductImage(fileInput, productIndex) {
      const file = fileInput.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        showNotification("Imagen inválida", "error");
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showNotification("Máximo 5MB", "error");
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("site_id", currentSiteId);
      try {
        showNotification("Subiendo imagen...", "info");
        const response = await fetchAPI("/api/upload-image", {
          method: "POST",
          body: formData,
          headers: {},
        });
        const data = await response.json();
        if (data.success) {
          const canonicalUrl = canonicalizeAssetUrl(data.url);
          updateProduct(productIndex, "image", canonicalUrl);
          renderProducts();
          showNotification("✅ Imagen subida", "success");
        } else {
          showNotification("Error al subir imagen", "error");
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification("Error al subir imagen", "error");
      }
    }

    async function uploadGalleryImage(file) {
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        showNotification("Selecciona una imagen válida", "error");
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showNotification("Máximo 5MB", "error");
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("site_id", currentSiteId);
      try {
        showNotification("Subiendo imagen...", "info");
        const response = await fetchAPI("/api/upload-image", {
          method: "POST",
          body: formData,
          headers: {},
        });
        const data = await response.json();
        if (data.success) {
          const canonicalUrl = canonicalizeAssetUrl(data.url);
          window.galleryData.push(canonicalUrl);
          renderGallery();
          showNotification("✅ Imagen subida", "success");
        } else {
          showNotification("Error al subir imagen", "error");
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification("Error al subir imagen", "error");
      }
    }

    function toggleUrlInput(type) {
      const urlGroup = document.getElementById(`${type}ImageUrlGroup`);
      if (!urlGroup) return;
      urlGroup.classList.toggle("hidden");
    }

    function toggleProductUrlInput(index) {
      const urlInput = document.getElementById(`product_url_${index}`);
      if (!urlInput) return;
      urlInput.classList.toggle("hidden");
      if (!urlInput.classList.contains("hidden")) {
        urlInput.focus();
      }
    }
  </script>
</body>
</html>