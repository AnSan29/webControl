<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Sitio - Control de Sitios</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .cname-assist {
            border: 1px solid #E2E8F0;
            border-radius: 1rem;
            background: #F8FAFC;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .cname-assist__grid {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .cname-assist__details {
            flex: 1 1 240px;
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .cname-assist__details ul {
            margin: 0.35rem 0 0;
            padding-left: 1.25rem;
        }
        .cname-assist code {
            background: rgba(15, 23, 42, 0.06);
            padding: 0.15rem 0.4rem;
            border-radius: 0.4rem;
            font-weight: 600;
            color: #0F172A;
        }
        .cname-assist__actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 220px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container flex items-center justify-between">
            <a href="/dashboard" class="navbar-brand"> Control de Sitios</a>
            <ul class="navbar-nav">
                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="/models" class="nav-link">Modelos</a></li>
                <li><a href="/create-site" class="nav-link active">Crear Sitio</a></li>
                <li><a href="#" onclick="logout()" class="nav-link">Cerrar Sesi贸n</a></li>
            </ul>
        </div>
    </nav>

    <main style="padding: 2rem 0;">
        <div class="container" style="max-width: 800px;">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Crear Nuevo Sitio</h1>
            
            <div class="card">
                <form id="createSiteForm">
                    <div class="form-group">
                        <label class="form-label">Modelo de Negocio</label>
                        <select id="model_type" name="model_type" class="form-select" required>
                            <option value="">Selecciona un modelo...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nombre del Negocio</label>
                        <input type="text" id="name" name="name" class="form-input" placeholder="Ej: Artesan铆as La Tradici贸n" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripci贸n</label>
                        <textarea id="description" name="description" class="form-textarea" placeholder="Describe tu negocio..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">T铆tulo Principal</label>
                        <input type="text" id="hero_title" name="hero_title" class="form-input" placeholder="Ej: Bienvenido a mi negocio">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Subt铆tulo</label>
                        <input type="text" id="hero_subtitle" name="hero_subtitle" class="form-input" placeholder="Ej: Productos de calidad">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Sobre Nosotros</label>
                        <textarea id="about_text" name="about_text" class="form-textarea" placeholder="Cu茅ntanos sobre tu negocio..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email de Contacto</label>
                        <input type="email" id="contact_email" name="contact_email" class="form-input" placeholder="contacto@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tel茅fono</label>
                        <input type="tel" id="contact_phone" name="contact_phone" class="form-input" placeholder="+1 234 567 8900">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Direcci贸n</label>
                        <input type="text" id="contact_address" name="contact_address" class="form-input" placeholder="Calle Principal #123">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dominio Personalizado (Opcional)</label>
                        <input type="text" id="custom_domain" name="custom_domain" class="form-input" placeholder="www.minegocio.com">
                        <small style="color: #6B7280;">Necesitar谩s configurar los DNS de tu dominio</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Configuraci贸n de CNAME</label>
                        <div class="cname-assist">
                            <div class="cname-assist__grid">
                                <div class="cname-assist__details">
                                    <p>Para que tu dominio personalizado funcione debes crear un registro CNAME en tu proveedor DNS apuntando a GitHub Pages.</p>
                                    <ul>
                                        <li><strong>Host / Alias:</strong> usa el subdominio que quieras (ej. <code>www</code>).</li>
                                        <li><strong>Destino:</strong> <code id="cnameTargetValue">ReconvencionLaboralGuajira.github.io</code></li>
                                    </ul>
                                    <small style="color: #94A3B8;">Los cambios pueden tardar hasta 30 minutos en propagarse.</small>
                                </div>
                                <div class="cname-assist__actions">
                                    <button type="button" class="btn btn-outline" id="copyCnameTarget">Copiar destino</button>
                                    <button type="button" class="btn btn-primary" id="confirmCnameButton">Confirmar configuraci贸n</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary">Crear Sitio</button>
                        <a href="/dashboard" class="btn btn-outline">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/static/js/main.js"></script>
    <script>
        async function init() {
            const isAuth = await checkAuth();
            if (!isAuth) return;

            // Cargar modelos en el select
            const models = await loadBusinessModels();
            const select = document.getElementById('model_type');
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.icon} ${model.name}`;
                select.appendChild(option);
            });

            // Si viene modelo en URL, pre-seleccionarlo
            const urlParams = new URLSearchParams(window.location.search);
            const modelParam = urlParams.get('model');
            if (modelParam) {
                select.value = modelParam;
            }
        }
        const CNAME_TARGET = 'reconvencionlaboralguajira.github.io';
        const customDomainInput = document.getElementById('custom_domain');
        const confirmCnameButton = document.getElementById('confirmCnameButton');
        const copyCnameButton = document.getElementById('copyCnameTarget');

        confirmCnameButton?.addEventListener('click', () => {
            const domain = customDomainInput.value.trim();
            if (!domain) {
                showNotification('Primero ingresa un dominio personalizado para configurar el CNAME.', 'warning');
                customDomainInput.focus();
                return;
            }
            showNotification(`Configura un registro CNAME para ${domain} apuntando a ${CNAME_TARGET}. 隆Te avisaremos cuando se propague!`, 'success');
        });

        copyCnameButton?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(CNAME_TARGET);
                showNotification('Destino CNAME copiado al portapapeles', 'success');
            } catch (error) {
                console.error(error);
                showNotification('No pudimos copiar el destino, c贸pialo manualmente.', 'error');
            }
        });

        document.getElementById('createSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetchAPI('/api/sites', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Sitio creado exitosamente', 'success');
                    setTimeout(() => {
                        window.location.href = `/editor/${result.id}`;
                    }, 1000);
                } else {
                    showNotification(result.detail || 'Error al crear sitio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al crear sitio', 'error');
            }
        });

        init();
    </script>
</body>
</html>
