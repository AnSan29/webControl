<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Usuarios - WebControl Studio</title>
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/ui-kit.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/img/webcontrol-logo.png" />
    <link rel="icon" type="image/svg+xml" href="/static/img/webcontrol-logo.svg" />
    <link rel="shortcut icon" href="/static/img/webcontrol-logo.png" />
    <link rel="apple-touch-icon" href="/static/img/webcontrol-logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --wc-surface-mute: rgba(255, 255, 255, 0.85);
      }
      [data-hover-lift] {
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      [data-hover-lift]:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 60px -30px rgba(15, 23, 42, 0.45);
      }
      .metric-value {
        transition: transform 0.35s ease;
      }
      .metric-bump {
        animation: metricPulse 0.45s ease;
      }
      @keyframes metricPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
      .wc-chip--muted {
        background: rgba(148, 163, 184, 0.12);
        color: rgba(71, 85, 105, 0.9);
      }
      .wc-chip--danger {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
      }
      .wc-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
      }
      .wc-toolbar__filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }
      .wc-filter-chip {
        border-radius: 9999px;
        padding: 0.35rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.6);
        color: rgba(71, 85, 105, 0.95);
        transition: all 0.2s ease;
      }
      .wc-filter-chip:hover,
      .wc-filter-chip.active {
        border-color: rgba(59, 130, 246, 0.45);
        color: #1d4ed8;
        background: rgba(59, 130, 246, 0.12);
        box-shadow: 0 15px 40px -25px rgba(37, 99, 235, 0.7);
      }
      .table-action {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: white;
        color: #0f172a;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .table-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 35px -25px rgba(15, 23, 42, 0.6);
        color: #2563eb;
      }
      .table-action--danger:hover {
        color: #dc2626;
      }
      .drawer-backdrop {
        backdrop-filter: blur(6px);
      }
      .modal-panel {
        animation: enter 0.3s ease-out;
        box-shadow: 0 45px 80px -40px rgba(15, 23, 42, 0.45);
        max-height: calc(100vh - 3rem);
        width: min(100%, 680px);
        display: flex;
        flex-direction: column;
        background: var(--wc-surface);
      }
      @keyframes enter {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      body.users-page .wc-page-heading {
        position: relative;
        overflow: hidden;
        border-radius: 36px;
        padding: 2.75rem;
        max-width: 100%;
        background: radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.35), transparent 55%),
          linear-gradient(135deg, #0f172a, #1e1b4b);
        box-shadow: 0 40px 120px -45px rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      body.users-page .wc-page-heading::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 80% 20%, rgba(14, 165, 233, 0.4), transparent 45%);
        mix-blend-mode: screen;
        pointer-events: none;
      }
      body.users-page .wc-page-heading > * {
        position: relative;
        z-index: 1;
      }
      body.users-page .wc-page-heading__eyebrow {
        color: rgba(241, 245, 249, 0.85);
      }
      body.users-page .wc-page-heading__title {
        color: #f8fafc;
      }
      body.users-page .wc-page-heading__subtitle {
        color: rgba(226, 232, 240, 0.92);
      }
      body.users-page .wc-page-heading__actions {
        margin-top: 1.35rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
      }
      body.users-page .wc-page-heading__actions .wc-button--ghost {
        background: rgba(15, 23, 42, 0.25);
        border-color: rgba(248, 250, 252, 0.35);
        color: #f8fafc;
        backdrop-filter: blur(6px);
      }
      body.users-page .wc-page-heading__actions .wc-button--ghost:hover {
        background: rgba(15, 23, 42, 0.45);
        border-color: rgba(248, 250, 252, 0.8);
        color: #ffffff;
      }
    </style>
  </head>
  <body class="wc-body users-page">
    <header class="wc-navbar">
      <div
        class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4 px-4 py-4"
      >
        <div class="flex items-center gap-3">
          <span
            class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-blue-600 text-white text-xl shadow-lg"
            >üë•</span
          >
          <div>
            <p class="wc-navbar__ghost">Operaciones</p>
            <p class="text-lg font-semibold text-slate-900">
              Gesti√≥n de usuarios
            </p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="newUserBtn" class="wc-button wc-button--primary">
            <i class="fas fa-user-plus"></i>
            Nuevo usuario
          </button>
          <button
            id="userMenuButton"
            type="button"
            class="wc-avatar-ring"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span><i class="fas fa-user"></i></span>
          </button>
          <div
            id="userMenu"
            class="hidden absolute right-4 top-20 w-60 rounded-2xl border border-slate-100 bg-white shadow-2xl"
          >
            <div class="px-4 py-4">
              <p class="text-sm font-semibold text-slate-900" id="userName">
                Admin
              </p>
              <p class="text-xs text-slate-500" id="userEmail">
                admin@webcontrol.com
              </p>
            </div>
            <button
              onclick="logout()"
              class="w-full border-t border-slate-100 px-4 py-3 text-left text-sm text-slate-600 hover:text-slate-900"
            >
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="wc-main">
      <div class="max-w-6xl mx-auto space-y-10">
        <section class="wc-page-heading">
          <span class="wc-page-heading__eyebrow">Control granular</span>
          <h1 class="wc-page-heading__title">Usuarios y roles</h1>
          <p class="wc-page-heading__subtitle">
            Administra permisos, estados y asignaci√≥n de sitios desde un panel
            dise√±ado para equipos de operaciones con grandes vol√∫menes de datos.
          </p>
          <div class="wc-page-heading__actions">
            <a
              href="/dashboard"
              class="wc-button wc-button--ghost"
              id="backToDashboardBtn"
            >
              <i class="fa-solid fa-arrow-left-long"></i>
              Volver al dashboard
            </a>
          </div>
        </section>

        <section class="wc-stats-grid">
          <article class="wc-stat-card" data-hover-lift>
            <p class="wc-stat-card__label">Usuarios totales</p>
            <p class="wc-stat-card__value metric-value" id="metricTotalUsers">
              0
            </p>
            <span class="wc-chip">En plataforma</span>
          </article>
          <article class="wc-stat-card" data-hover-lift>
            <p class="wc-stat-card__label">Activos</p>
            <p class="wc-stat-card__value metric-value" id="metricActiveUsers">
              0
            </p>
            <span class="wc-chip wc-chip--success">Con acceso</span>
          </article>
          <article class="wc-stat-card" data-hover-lift>
            <p class="wc-stat-card__label">Owners</p>
            <p class="wc-stat-card__value metric-value" id="metricOwnerUsers">
              0
            </p>
            <span class="wc-chip wc-chip--warning">Propietarios</span>
          </article>
        </section>

        <section class="wc-card" data-hover-lift>
          <div class="p-6 space-y-6">
            <div class="wc-toolbar">
              <div class="flex-1 max-w-lg relative">
                <span
                  class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400"
                  ><i class="fa-solid fa-magnifying-glass"></i
                ></span>
                <input
                  type="text"
                  id="searchInput"
                  class="wc-form-control pl-11"
                  placeholder="Buscar por nombre, correo o rol"
                />
              </div>
              <div class="wc-toolbar__filters">
                <span class="text-xs uppercase tracking-[0.3em] text-slate-500"
                  >Filtros</span
                >
                <button
                  class="wc-filter-chip active"
                  type="button"
                  data-filter="all"
                >
                  Todos
                </button>
                <button
                  class="wc-filter-chip"
                  type="button"
                  data-filter="owners"
                >
                  Owners
                </button>
                <button
                  class="wc-filter-chip"
                  type="button"
                  data-filter="admins"
                >
                  Admins
                </button>
                <button
                  class="wc-filter-chip"
                  type="button"
                  data-filter="suspended"
                >
                  Suspendidos
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="wc-table">
                <thead>
                  <tr>
                    <th>Usuario</th>
                    <th>Rol / Grupo</th>
                    <th>Estado</th>
                    <th>Activaci√≥n</th>
                    <th>Expiraci√≥n</th>
                    <th>√öltimo acceso</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr>
                    <td colspan="7">
                      <div class="wc-empty-state">
                        <h4>Sin usuarios a√∫n</h4>
                        <p>
                          Cuando los registres aparecer√°n aqu√≠ con sus m√©tricas.
                        </p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div
              class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
            >
              <div class="flex items-center gap-2 text-sm text-slate-600">
                <span>√çtems por p√°gina</span>
                <select id="pageSizeSelect" class="wc-form-control w-24">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </div>
              <div class="flex items-center gap-3">
                <span id="pageInfo" class="text-sm text-slate-600"
                  >Mostrando 0 de 0 usuarios</span
                >
                <div class="flex gap-2">
                  <button id="prevPageBtn" class="table-action" disabled>
                    <i class="fa-solid fa-chevron-left"></i>
                  </button>
                  <button id="nextPageBtn" class="table-action" disabled>
                    <i class="fa-solid fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- User Form Modal -->
    <div id="userDrawer" class="fixed inset-0 z-50 hidden">
      <div class="drawer-backdrop absolute inset-0 bg-slate-900/60"></div>
      <div
        class="relative flex min-h-full items-start sm:items-center justify-center px-3 sm:px-6 py-6 sm:py-10"
      >
        <section class="modal-panel rounded-3xl">
          <header
            class="flex items-start justify-between border-b border-slate-100 px-6 py-5"
          >
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-blue-500">
                Gesti√≥n de usuarios
              </p>
              <h2
                id="drawerTitle"
                class="mt-1 text-2xl font-semibold text-slate-900"
              >
                Nuevo Usuario
              </h2>
              <p class="mt-1 text-sm text-slate-500">
                Completa la informaci√≥n para crear o actualizar la cuenta.
              </p>
            </div>
            <button
              id="closeDrawerBtn"
              class="rounded-full p-2 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600"
              aria-label="Cerrar"
            >
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </header>

          <div class="flex-1 overflow-y-auto px-6 py-6 space-y-6">
            <div
              class="rounded-2xl border border-blue-100 bg-blue-50/80 p-4 text-sm text-blue-900 flex gap-3"
              data-hover-lift
            >
              <i class="fa-solid fa-circle-info text-blue-500 text-xl"></i>
              <div>
                <p class="font-semibold">Consejo r√°pido</p>
                <p class="text-blue-900/80">
                  Los Owners requieren un sitio asignado y tienen acceso
                  completo a su espacio; los Administradores pueden gestionar
                  m√∫ltiples sitios.
                </p>
              </div>
            </div>

            <div
              id="userMetaSection"
              class="hidden rounded-2xl border border-slate-100 bg-slate-50/70 p-4 text-sm text-slate-600 space-y-4"
            >
              <div class="grid gap-4 md:grid-cols-3">
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    ID interno
                  </p>
                  <p id="metaId" class="mt-1 text-slate-900 font-semibold">‚Äî</p>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Rol asignado
                  </p>
                  <p id="metaRole" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Sitio
                  </p>
                  <p id="metaSite" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
              </div>
              <div class="grid gap-4 md:grid-cols-3">
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Estado
                  </p>
                  <p id="metaStatus" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    √öltimo acceso
                  </p>
                  <p
                    id="metaLastLogin"
                    class="mt-1 text-slate-900 font-semibold"
                  >
                    ‚Äî
                  </p>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Expira
                  </p>
                  <p id="metaExpires" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
              </div>
              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Creado
                  </p>
                  <p id="metaCreated" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">
                    Actualizado
                  </p>
                  <p id="metaUpdated" class="mt-1 text-slate-900 font-semibold">
                    ‚Äî
                  </p>
                </div>
              </div>
              <div class="flex flex-col gap-2">
                <p class="text-xs uppercase tracking-widest text-slate-400">
                  Contrase√±a visible
                </p>
                <div class="flex flex-wrap items-center gap-2">
                  <code
                    id="metaPassword"
                    class="rounded-lg bg-white px-3 py-1 text-base font-semibold text-slate-800"
                    >‚Äî</code
                  >
                  <button
                    type="button"
                    id="copyPasswordBtn"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-white transition disabled:opacity-40"
                  >
                    <i class="fa-solid fa-copy"></i>
                    Copiar
                  </button>
                </div>
              </div>
            </div>

            <form id="userForm" class="space-y-6">
              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label
                    for="username"
                    class="text-sm font-medium text-slate-700"
                    >Nombre de usuario</label
                  >
                  <input
                    type="text"
                    id="username"
                    name="username"
                    required
                    class="wc-form-control mt-1"
                    placeholder="ej. maria.campos"
                  />
                </div>
                <div>
                  <label for="email" class="text-sm font-medium text-slate-700"
                    >Correo electr√≥nico</label
                  >
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    class="wc-form-control mt-1"
                    placeholder="usuario@webcontrol.com"
                  />
                </div>
              </div>

              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label
                    for="password"
                    class="text-sm font-medium text-slate-700"
                    >Contrase√±a</label
                  >
                  <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    class="wc-form-control mt-1"
                    placeholder="M√≠nimo 8 caracteres"
                  />
                  <p class="mt-1 text-xs text-slate-500">
                    D√©jalo vac√≠o para mantener la contrase√±a actual.
                  </p>
                </div>
                <div>
                  <label for="role" class="text-sm font-medium text-slate-700"
                    >Rol</label
                  >
                  <select
                    id="role"
                    name="role"
                    required
                    class="wc-form-control mt-1"
                  >
                    <option value="">Seleccionar rol</option>
                    <option value="owner">Owner</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
              </div>

              <div id="siteField" class="hidden">
                <label for="site_id" class="text-sm font-medium text-slate-700"
                  >Sitio asignado</label
                >
                <select
                  id="site_id"
                  name="site_id"
                  class="wc-form-control mt-1"
                >
                  <option value="">Seleccionar sitio</option>
                </select>
              </div>

              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label
                    for="expires_at"
                    class="text-sm font-medium text-slate-700"
                    >Fecha de expiraci√≥n (opcional)</label
                  >
                  <input
                    type="datetime-local"
                    id="expires_at"
                    name="expires_at"
                    class="wc-form-control mt-1"
                  />
                </div>
                <div
                  class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 mt-6 md:mt-8"
                >
                  <input
                    type="checkbox"
                    id="is_active"
                    name="is_active"
                    checked
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                  />
                  <div>
                    <label
                      for="is_active"
                      class="text-sm font-medium text-slate-800"
                      >Usuario activo</label
                    >
                    <p class="text-xs text-slate-500">
                      Desactiva el acceso temporalmente sin eliminar la cuenta.
                    </p>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <footer
            class="flex flex-col gap-3 border-t border-slate-100 bg-slate-50 px-6 py-4 sm:flex-row sm:justify-end"
          >
            <button
              id="cancelBtn"
              type="button"
              class="w-full rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-white sm:w-auto"
            >
              Cancelar
            </button>
            <button
              id="saveBtn"
              type="button"
              class="w-full rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 sm:w-auto"
            >
              Guardar
            </button>
          </footer>
        </section>
      </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
      let users = [];
      let filteredUsers = [];
      let currentPage = 1;
      let pageSize = 10;
      let editingUserId = null;
      let activeFilter = "all";
      const numberFormatter = new Intl.NumberFormat("es-ES");

      const searchInput = document.getElementById("searchInput");
      const usersTableBody = document.getElementById("usersTableBody");
      const pageInfoEl = document.getElementById("pageInfo");
      const prevPageBtn = document.getElementById("prevPageBtn");
      const nextPageBtn = document.getElementById("nextPageBtn");
      const pageSizeSelect = document.getElementById("pageSizeSelect");
      const filterChips = document.querySelectorAll(".wc-filter-chip");

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function formatDateTime(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleString("es-ES", {
          dateStyle: "medium",
          timeStyle: "short",
        });
      }

      function toInputDateValue(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
      }

      function inputDateToISOString(value) {
        if (!value) return null;
        const date = new Date(value);
        return isNaN(date.getTime()) ? null : date.toISOString();
      }

      function formatInteger(value) {
        return numberFormatter.format(value ?? 0);
      }

      function getInitials(name = "") {
        return (
          name
            .split(" ")
            .map((n) => n[0] || "")
            .join("")
            .toUpperCase()
            .slice(0, 2) || "?"
        );
      }

      function getRoleBadge(role) {
        const badges = {
          superadmin: '<span class="wc-chip wc-chip--danger">Superadmin</span>',
          admin: '<span class="wc-chip wc-chip--warning">Administrador</span>',
          owner: '<span class="wc-chip wc-chip--success">Owner</span>',
        };
        return (
          badges[role] ||
          `<span class="wc-chip wc-chip--muted">${role || "‚Äî"}</span>`
        );
      }

      function getStatusBadge(user) {
        const now = new Date();
        const isExpired = user.expires_at
          ? new Date(user.expires_at) < now
          : false;
        if (!user.is_active)
          return '<span class="wc-chip wc-chip--danger">Suspendido</span>';
        if (isExpired)
          return '<span class="wc-chip wc-chip--warning">Expirado</span>';
        return '<span class="wc-chip wc-chip--success">Activo</span>';
      }

      function getSiteChip(user) {
        if (user.site && user.site.name) {
          return `<span class="wc-chip wc-chip--muted"><i class="fa-solid fa-earth-americas mr-1"></i>${user.site.name}</span>`;
        }
        return '<span class="wc-chip wc-chip--muted"><i class="fa-regular fa-circle mr-1"></i>Sin sitio asignado</span>';
      }

      function renderRow(user) {
        const avatar = getInitials(user.username);
        const activationDate = formatDate(user.activated_at);
        const expirationDate = formatDate(user.expires_at);
        const lastLogin = formatDateTime(user.last_login);
        const roleBadge = getRoleBadge(user.role);
        const statusBadge = getStatusBadge(user);
        const siteChip = getSiteChip(user);
        const idChip = `<span class="wc-chip wc-chip--muted">ID #${user.id}</span>`;
        const roleDescriptor = user.role_display || user.role_label;

        return `
		<tr>
			<td class="align-top">
				<div class="flex items-center gap-3">
					<div class="wc-avatar-ring">
						<span>${avatar}</span>
					</div>
					<div>
						<div class="text-sm font-semibold text-slate-900">${user.username}</div>
						<div class="text-xs text-slate-500">${user.email}</div>
						<div class="mt-2 flex flex-wrap gap-2 text-xs">${siteChip}${idChip}</div>
					</div>
				</div>
			</td>
			<td class="align-top text-sm">
				${roleBadge}
				${
          roleDescriptor
            ? `<p class="text-xs text-slate-500 mt-1">${roleDescriptor}</p>`
            : ""
        }
			</td>
			<td class="align-top text-sm">${statusBadge}</td>
			<td class="align-top text-sm text-slate-900">${activationDate}</td>
			<td class="align-top text-sm text-slate-900">${expirationDate}</td>
			<td class="align-top text-sm text-slate-900">${lastLogin}</td>
			<td class="align-top">
				<div class="flex gap-2">
					<button class="table-action" aria-label="Editar usuario" onclick="editUser(${
            user.id
          })">
						<i class="fa-solid fa-pen-to-square"></i>
					</button>
					<button class="table-action table-action--danger" aria-label="Eliminar usuario" onclick="deleteUser(${
            user.id
          })">
						<i class="fa-solid fa-trash"></i>
					</button>
				</div>
			</td>
		</tr>
	`;
      }

      function updateTable() {
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageUsers = filteredUsers.slice(start, end);

        if (!pageUsers.length) {
          usersTableBody.innerHTML = `
			<tr>
				<td colspan="7">
					<div class="wc-empty-state">
						<h4>No hay coincidencias</h4>
						<p>Ajusta la b√∫squeda o crea un nuevo usuario.</p>
					</div>
				</td>
			</tr>
		`;
        } else {
          usersTableBody.innerHTML = pageUsers.map(renderRow).join("");
        }

        updatePagination();
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredUsers.length / pageSize) || 1;
        if (filteredUsers.length === 0) {
          pageInfoEl.textContent = "Mostrando 0 de 0 usuarios";
        } else {
          const start = (currentPage - 1) * pageSize + 1;
          const end = Math.min(currentPage * pageSize, filteredUsers.length);
          pageInfoEl.textContent = `Mostrando ${start}-${end} de ${filteredUsers.length} usuarios`;
        }
        prevPageBtn.disabled = currentPage === 1 || filteredUsers.length === 0;
        nextPageBtn.disabled =
          currentPage === totalPages || filteredUsers.length === 0;
      }

      function applyFilters() {
        const query = (searchInput?.value || "").toLowerCase();
        filteredUsers = users.filter((user) => {
          const matchesSearch =
            user.username?.toLowerCase().includes(query) ||
            user.email?.toLowerCase().includes(query) ||
            (user.role || "").toLowerCase().includes(query);

          if (!matchesSearch) return false;

          switch (activeFilter) {
            case "owners":
              return (user.role || "").toLowerCase() === "owner";
            case "admins":
              return (user.role || "").toLowerCase() === "admin";
            case "suspended":
              return !user.is_active;
            default:
              return true;
          }
        });

        currentPage = 1;
        updateTable();
      }

      function updateDashboardMetrics() {
        const metrics = {
          total: users.length,
          active: users.filter(
            (u) =>
              u.is_active &&
              (!u.expires_at || new Date(u.expires_at) >= new Date())
          ).length,
          owners: users.filter((u) => (u.role || "").toLowerCase() === "owner")
            .length,
        };

        const mapping = {
          metricTotalUsers: metrics.total,
          metricActiveUsers: metrics.active,
          metricOwnerUsers: metrics.owners,
        };

        Object.entries(mapping).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (!element) return;
          element.textContent = formatInteger(value);
          element.classList.remove("metric-bump");
          void element.offsetWidth;
          element.classList.add("metric-bump");
        });
      }

      async function loadUsers() {
        try {
          const response = await fetchAPI("/api/users");
          if (!response || !response.ok)
            throw new Error("Error al cargar usuarios");
          users = await response.json();
          filteredUsers = [...users];
          updateTable();
          updateDashboardMetrics();
        } catch (error) {
          console.error("Error loading users:", error);
          showNotification("Error al cargar usuarios", "error");
        }
      }

      async function loadSites() {
        try {
          const response = await fetchAPI("/api/sites");
          if (!response || !response.ok)
            throw new Error("Error al cargar sitios");
          const sites = await response.json();
          const siteSelect = document.getElementById("site_id");
          if (!siteSelect) return;
          siteSelect.innerHTML = '<option value="">Seleccionar sitio</option>';
          sites.forEach((site) => {
            const option = document.createElement("option");
            option.value = site.id;
            option.textContent = site.name;
            siteSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading sites:", error);
        }
      }

      function showDrawer(title, user = null) {
        document.getElementById("drawerTitle").textContent = title;
        document.getElementById("userDrawer").classList.remove("hidden");
        updateUserMeta(user);

        if (user) {
          editingUserId = user.id;
          document.getElementById("username").value = user.username;
          document.getElementById("email").value = user.email;
          document.getElementById("password").required = false;
          document.getElementById("password").value = "";
          document.getElementById("role").value = user.role;
          document.getElementById("site_id").value = user.site_id || "";
          document.getElementById("expires_at").value = toInputDateValue(
            user.expires_at
          );
          document.getElementById("is_active").checked = user.is_active;
          toggleSiteField(user.role);
        } else {
          editingUserId = null;
          document.getElementById("userForm").reset();
          document.getElementById("password").required = true;
          toggleSiteField("");
        }
      }

      function hideDrawer() {
        document.getElementById("userDrawer").classList.add("hidden");
        editingUserId = null;
        updateUserMeta(null);
      }

      function toggleSiteField(role) {
        const siteField = document.getElementById("siteField");
        if (!siteField) return;
        const isOwner = role === "owner";
        siteField.classList.toggle("hidden", !isOwner);
        const siteSelect = document.getElementById("site_id");
        if (siteSelect) siteSelect.required = isOwner;
      }

      function updateUserMeta(user) {
        const section = document.getElementById("userMetaSection");
        const copyButton = document.getElementById("copyPasswordBtn");
        const passwordEl = document.getElementById("metaPassword");
        if (!section || !copyButton || !passwordEl) return;

        if (!user) {
          section.classList.add("hidden");
          passwordEl.text_content = "‚Äî";
          copyButton.disabled = true;
          copyButton.dataset.password = "";
          [
            "metaId",
            "metaRole",
            "metaSite",
            "metaStatus",
            "metaLastLogin",
            "metaCreated",
            "metaUpdated",
            "metaExpires",
          ].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = "‚Äî";
          });
          return;
        }

        section.classList.remove("hidden");
        document.getElementById("metaId").textContent = `#${user.id}`;
        document.getElementById("metaRole").textContent =
          user.role_display || user.role_label || user.role || "‚Äî";
        document.getElementById("metaSite").textContent =
          user.site && user.site.name ? user.site.name : "Sin sitio asignado";
        document.getElementById("metaStatus").innerHTML = getStatusBadge(user);
        document.getElementById("metaLastLogin").textContent = formatDateTime(
          user.last_login
        );
        document.getElementById("metaCreated").textContent = formatDateTime(
          user.created_at
        );
        document.getElementById("metaUpdated").textContent = formatDateTime(
          user.updated_at
        );
        document.getElementById("metaExpires").textContent = formatDateTime(
          user.expires_at
        );
        const passwordValue = user.plain_password || "‚Äî";
        passwordEl.textContent = passwordValue;
        copyButton.disabled = !user.plain_password;
        copyButton.dataset.password = user.plain_password || "";
      }

      async function handleUserSubmit() {
        const formEl = document.getElementById("userForm");
        const formData = new FormData(formEl);
        const isEditing = Boolean(editingUserId);
        const rawPassword = (formData.get("password") || "").trim();

        const payload = {
          username: formData.get("username").trim(),
          email: formData.get("email").trim(),
          role: formData.get("role"),
          site_id: formData.get("site_id") || null,
          expires_at: inputDateToISOString(formData.get("expires_at")),
          is_active: formData.has("is_active"),
        };

        if (!isEditing && rawPassword.length < 8) {
          showNotification(
            "La contrase√±a debe tener al menos 8 caracteres.",
            "warning"
          );
          return;
        }

        if (isEditing && rawPassword && rawPassword.length < 8) {
          showNotification(
            "La nueva contrase√±a debe tener al menos 8 caracteres.",
            "warning"
          );
          return;
        }

        if (!isEditing || rawPassword) {
          payload.password = rawPassword;
        }

        try {
          let response;
          if (editingUserId) {
            response = await fetchAPI(`/api/users/${editingUserId}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            response = await fetchAPI("/api/users", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }

          if (!response || !response.ok) throw new Error("Error al guardar");
          hideDrawer();
          await loadUsers();
          showNotification("Usuario guardado correctamente", "success");
        } catch (error) {
          console.error("Error saving user:", error);
          showNotification("Error al guardar usuario", "error");
        }
      }

      async function deleteUser(userId) {
        const confirmed = await confirmAction("¬øEliminar este usuario?", {
          title: "Eliminar usuario",
          icon: "warning",
          confirmText: "S√≠, eliminar",
        });
        if (!confirmed) return;

        try {
          const response = await fetchAPI(`/api/users/${userId}`, {
            method: "DELETE",
          });
          if (!response || !response.ok) throw new Error("Error al eliminar");
          await loadUsers();
          showNotification("Usuario eliminado", "success");
        } catch (error) {
          console.error("Error deleting user:", error);
          showNotification("Error al eliminar usuario", "error");
        }
      }

      function editUser(userId) {
        const user = users.find((u) => u.id === userId);
        if (user) showDrawer("Editar Usuario", user);
      }

      function setupEventListeners() {
        searchInput?.addEventListener("input", () => applyFilters());

        filterChips.forEach((chip) => {
          chip.addEventListener("click", () => {
            filterChips.forEach((c) => c.classList.remove("active"));
            chip.classList.add("active");
            activeFilter = chip.dataset.filter;
            applyFilters();
          });
        });

        pageSizeSelect?.addEventListener("change", (event) => {
          pageSize = parseInt(event.target.value, 10) || 10;
          currentPage = 1;
          updateTable();
        });

        prevPageBtn?.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            updateTable();
          }
        });

        nextPageBtn?.addEventListener("click", () => {
          const totalPages = Math.ceil(filteredUsers.length / pageSize) || 1;
          if (currentPage < totalPages) {
            currentPage++;
            updateTable();
          }
        });

        document
          .getElementById("newUserBtn")
          ?.addEventListener("click", () => showDrawer("Nuevo Usuario"));
        document
          .getElementById("saveBtn")
          ?.addEventListener("click", handleUserSubmit);
        document
          .getElementById("cancelBtn")
          ?.addEventListener("click", hideDrawer);
        document
          .getElementById("closeDrawerBtn")
          ?.addEventListener("click", hideDrawer);
        document
          .getElementById("role")
          ?.addEventListener("change", (e) => toggleSiteField(e.target.value));

        const copyPasswordBtn = document.getElementById("copyPasswordBtn");
        copyPasswordBtn?.addEventListener("click", async () => {
          const value = copyPasswordBtn.dataset.password;
          if (!value) return;
          try {
            await navigator.clipboard.writeText(value);
            showNotification("Contrase√±a copiada al portapapeles", "success");
          } catch (error) {
            console.error("Clipboard error:", error);
            showNotification("No se pudo copiar la contrase√±a", "error");
          }
        });

        const userMenuButton = document.getElementById("userMenuButton");
        const userMenu = document.getElementById("userMenu");
        if (userMenuButton && userMenu) {
          userMenuButton.addEventListener("click", (event) => {
            event.stopPropagation();
            userMenu.classList.toggle("hidden");
            const expanded =
              userMenuButton.getAttribute("aria-expanded") === "true";
            userMenuButton.setAttribute(
              "aria-expanded",
              (!expanded).toString()
            );
          });
          window.addEventListener("click", (event) => {
            if (
              !userMenu.contains(event.target) &&
              !userMenuButton.contains(event.target)
            ) {
              userMenu.classList.add("hidden");
              userMenuButton.setAttribute("aria-expanded", "false");
            }
          });
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        setupEventListeners();
        try {
          if (typeof checkAuth === "function") {
            const isAuth = await checkAuth();
            if (!isAuth) return;
          }
          await Promise.all([loadUsers(), loadSites()]);
        } catch (error) {
          console.error("Error initializing users page:", error);
        }
      });
    </script>
  </body>
</html>
